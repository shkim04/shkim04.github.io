{"componentChunkName":"component---src-templates-blog-post-js","path":"/nestjs-guards-적용하기/","result":{"data":{"site":{"siteMetadata":{"title":"Seunghyun's Blog"}},"markdownRemark":{"id":"e05965db-d559-5d78-ac42-87b68b2a2748","excerpt":"지난 글에서 Toilet, Address와 Review에 대해 CRUD 작업을 하는 Graphql…","html":"<p>지난 글에서 Toilet, Address와 Review에 대해 CRUD 작업을 하는 Graphql 서버를 구성했습니다. 이 어플리케이션으로 여러 사람으로부터 화장실에 대한 정보를 얻으려고 합니다. 하지만 임의의 사용자가 자신이 작성하지 않을 리뷰를 지우는 것을 허용하지 않아야 합니다. 이를 위해 <code class=\"language-text\">review</code> Resolver에 <strong>Guard</strong>를 적용할 것입니다.</p>\n<h2>Review Schema 수정</h2>\n<p><code class=\"language-text\">Review</code> 모델에 password 필드가 없었기 때문에 이 필드를 추가하고 <code class=\"language-text\">npx prisma migrate dev --create-only</code>라는 명령어를 통해 데이터베이스에 재등록을 시킵니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">model Review <span class=\"token punctuation\">{</span>\r\n    <span class=\"token operator\">...</span>\r\n    contributedBy String   @unique\r\n    password      String\r\n    toiletId      String\r\n    <span class=\"token operator\">...</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Review DTO 수정</h2>\n<p>리뷰를 남기는 사용자가 리뷰를 작성할 때 비밀번호와 함께 생성되도록 하여 해당 리뷰를 지우려고 할 때 누군지 확인할 수 있게 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// create-review.input.ts</span>\r\n@<span class=\"token function\">InputType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CreateReviewInput</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token operator\">...</span>\r\n\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  toiletId<span class=\"token operator\">?</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\r\n\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  @<span class=\"token function\">IsEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token literal-property property\">contributedBy</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\r\n\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token literal-property property\">password</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음과 같이 delete-review input에도 password 필드를 추가합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// delete-review.input.ts</span>\r\n@<span class=\"token function\">InputType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DeleteReviewInput</span> <span class=\"token punctuation\">{</span>\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\r\n\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token literal-property property\">contributedBy</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\r\n\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token literal-property property\">password</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Guard 작성</h2>\n<p><code class=\"language-text\">src</code>폴더 하위에 <code class=\"language-text\">guards</code>라는 폴더를 생성하고 해당 폴더 하위에 <code class=\"language-text\">review.guard.ts</code>라는 파일을 만듭니다. <strong>Guard</strong>를 사용하면 요청 객체에서 정보를 얻어 이를 사용해 <strong>라우터 핸들러</strong>에서 처리해도 될지 말지를 결정할 수 있습니다. 간단하게 말해 authorization/authention이 이루어지는 곳이라고 봐도 되겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Injectable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ReviewAuthGuard</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">CanActivate</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">@<span class=\"token function\">Inject</span><span class=\"token punctuation\">(</span>ReviewsService<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token literal-property property\">reviewsService</span><span class=\"token operator\">:</span> ReviewsService</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">canActivate</span><span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> GqlExecutionContext<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>boolean<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> GqlExecutionContext<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> deleteReviewData <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">getArgs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> contributedBy<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> deleteReviewData<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">const</span> reviewInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>reviewsService<span class=\"token punctuation\">.</span><span class=\"token function\">getReview</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\r\n      reviewInfo<span class=\"token punctuation\">.</span>contributedBy <span class=\"token operator\">===</span> contributedBy <span class=\"token operator\">&amp;&amp;</span>\r\n      reviewInfo<span class=\"token punctuation\">.</span>password <span class=\"token operator\">===</span> password\r\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>주의: REST 대신 Graphql를 사용하므로 <strong>GqlExecutionContext</strong>를 import해야 합니다.</p>\n</blockquote>\n<p>이 가드는 delete review input이 담긴 인자(argument)를 얻고 이 안에 담긴 이메일과 비밀번호를 <code class=\"language-text\">reviewService</code>로 불러온 리뷰 정보에 담긴 이메일과 비밀번호와 비교합니다. 이 정보들이 일치한다면 해당 요청이 <strong>라우터 핸들러</strong>로 가게 됩니다.</p>\n<h2>UseGuards 데코레이터</h2>\n<p>마지막으로 이 가드를 사용하려면 <code class=\"language-text\">review</code> Resolver에 있는 대상 메소드 위에 <code class=\"language-text\">UseGuards</code> 데코레이터를 위치시키고 <code class=\"language-text\">ReviewAuthGuard</code>를 인자로 전달해야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Mutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Review<span class=\"token punctuation\">)</span>\r\n@<span class=\"token function\">UseGuards</span><span class=\"token punctuation\">(</span>ReviewAuthGuard<span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">async</span> <span class=\"token function\">deleteReview</span><span class=\"token punctuation\">(</span>\r\n  @<span class=\"token function\">Args</span><span class=\"token punctuation\">(</span><span class=\"token string\">'deleteReviewData'</span><span class=\"token punctuation\">)</span> deleteReviewData<span class=\"token operator\">:</span> DeleteReviewInput<span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>Review<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>reviewService<span class=\"token punctuation\">.</span><span class=\"token function\">deleteReview</span><span class=\"token punctuation\">(</span>deleteReviewData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>테스트</h2>\n<h3>리뷰 생성</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0b81a702c0abf875be6612f3882a60b5/c54b3/create-review.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.45569620253164%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABmklEQVR42p2T23KbMBRF/QG2AfnSuLFBd0QMSAhBEk///7d2B2Fn0jZ12jwsHQaN1px9NFpk5QVZ9QOpuYDogIQ1SOhMymZu39Pemr6nvtK81UXCLTZ1wNYN2NkBmzbgcB4glcdTFaDLHqUJqJ8GUN1jLztsmAVhNtYbW+aQ0RaLyboXFtJ4lFUPVvV4lD2EegWTL8hFiJx4DyZGFGJALgaceEDOB1AxgotncDFiy+ws3PEW2vRQxsdKtUOqRqzUGKPcRpDQjyL/+m+xKho8She7E6WHqQJy3WEjB3xXLyC0xep6cHmtyR0W66LBN2Fjd7ly0MZDmR4H6UDFECM+cB9ndGAehNq70ijccwtdzZHFFL0MEHoAE88o5SuMvMT5HUWIF3BXOC0H7XHSHkflsJcWSdHGbo68j909MI8dc1jS8+eRpyXTHRJlsczPWBc1kqKOc3vP75fzd2HRIFUWpPHITIfs7EFsQFY6pEWN9B8kfwq1A3EBpAvI6h7pFJu3/yV6E6a0BZFuFkxMT6xoviSLQiLclw9/JPwJ5YZppwTlQ8QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"create-reivew\"\n        title=\"\"\n        src=\"/static/0b81a702c0abf875be6612f3882a60b5/f058b/create-review.png\"\n        srcset=\"/static/0b81a702c0abf875be6612f3882a60b5/c26ae/create-review.png 158w,\n/static/0b81a702c0abf875be6612f3882a60b5/6bdcf/create-review.png 315w,\n/static/0b81a702c0abf875be6612f3882a60b5/f058b/create-review.png 630w,\n/static/0b81a702c0abf875be6612f3882a60b5/c54b3/create-review.png 727w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>일치하는 비밀번호로 리뷰 지우기</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a86b031dfd80e0219996585f0f2a04e8/ace37/delete-review.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.43037974683544%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABgklEQVR42p2S227qMBBFeS/kAu0RUEhiO3aSkpudC/D/H7aqJJwjKlVHVR+2Z+TL8mzNrMLsRqgn3QmlJUwq/KhkE0+qWMfVIy9ZP/b8uMSf7n2jVaB7ts2dsLmzrQeCiyX4sCSZ5axbhLEkZslVZtmnDYFs2CTlF3l/gV5S8pq3HC6OfT4QFzfeiyvGXMnNFAeU7jFmJM9GhB44qI5EjZxkx1n1CDWyl3aGrry44jWpkcZxUpZCj+R6wGQDB9kh1RWlrmh15ySGOZ5lz1F2HKXjIB0n2bMTzQOYVPxRDVnRkRYOXTjizM3AKO1nWJ7e0eltruogHIGoWT/ZXT9bnpZj1hEbR6RbjqrFi0reopZIDbzLbq5gquhNtGySy7/H3zclqdhqi5dZ1mmNl7WEhcW/WF7E8vvc3Qco+A9sqXAaAdOw60d2bmDnRsKLmxWIBRD8AOQ/Ww51S5hbgsISmBY/XmbR/yHkC3CrGsKkXgCT4sehqH4HDGWNN9kWv4c8Az8BA5oyckXRY4MAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"delete-review\"\n        title=\"\"\n        src=\"/static/a86b031dfd80e0219996585f0f2a04e8/f058b/delete-review.png\"\n        srcset=\"/static/a86b031dfd80e0219996585f0f2a04e8/c26ae/delete-review.png 158w,\n/static/a86b031dfd80e0219996585f0f2a04e8/6bdcf/delete-review.png 315w,\n/static/a86b031dfd80e0219996585f0f2a04e8/f058b/delete-review.png 630w,\n/static/a86b031dfd80e0219996585f0f2a04e8/ace37/delete-review.png 666w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>일치하지 않는 비밀번호로 리뷰 응답</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 585px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/777c400960075915e9ad410001ab2d9f/78a22/delete-forbidden.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.39240506329114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABQklEQVR42p2Ty26DMBBF8xPBHtNKbdNNABsnbYKJbSCR+kofi/7/v9zKPBKkZkMWR9gDur4zF89i5SGUxzzZIUp2mCe2fbL0OmZsWSBWDgtd4C43eNAF7rUBSQee2emCIusWi5XBY0BvcCsNKLPgw4dJz7JnXBsYBIOTsIhSByY95rIBUzW4qsBlBR4OzC2YduCrDiYteB5wLSx3o5ZPdkuwzCI2PxDFF2L7i3h7BOkKZBqQqUG2Abl9J1zUoLKvb2sMxmZCuXNrmQWtX0DP7y1ic2z3sfSg8H5ZdpxGMNr/dxhSLkHKQeRVn3QJltqJKV8o8syB1q+gpzeQ8qD8cO5ismBStuGIzQeE+Ua8/YTQBzC1ny4Yte4sSHpw1YDrQ0cYuKyucxhuTfgHWWJGlP08pwiGQKTDja4RpRY881fdlD+U7mc8oVkWbwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"delete-forbidden\"\n        title=\"\"\n        src=\"/static/777c400960075915e9ad410001ab2d9f/78a22/delete-forbidden.png\"\n        srcset=\"/static/777c400960075915e9ad410001ab2d9f/c26ae/delete-forbidden.png 158w,\n/static/777c400960075915e9ad410001ab2d9f/6bdcf/delete-forbidden.png 315w,\n/static/777c400960075915e9ad410001ab2d9f/78a22/delete-forbidden.png 585w\"\n        sizes=\"(max-width: 585px) 100vw, 585px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>정리</h2>\n<p><strong>Guard</strong>를 사용하여 사용자를 인증하면 그 인증 기능을 집중시켜 어플리케이션 전체에 사용할 수 있다는 것이 큰 매력입니다. 하지만 보시다시피 필자는 인증을 아주 단순하게 처리했습니다. 다음 글에서는 <code class=\"language-text\">passport</code>와 <code class=\"language-text\">bcrypt</code>를 사용하여 이 과정을 심화시켜 보겠습니다.</p>\n<p><em><strong>읽어 주셔서 감사합니다. To be continued!</strong></em></p>\n<h3>참조</h3>\n<ul>\n<li><a href=\"https://docs.nestjs.com/graphql/other-features\">https://docs.nestjs.com/graphql/other-features</a></li>\n<li><a href=\"https://docs.nestjs.com/guards\">https://docs.nestjs.com/guards</a></li>\n</ul>","frontmatter":{"title":"#5 리뷰 임의 삭제 방지를 위한 Guard 적용하기","date":"2023년 08월 02일","description":"","tag":["Project","NodeJS"]},"fields":{"locale":"ko"}},"previous":{"fields":{"slug":"/nestjs-graphql-prisma-postgresql-구성하기"},"frontmatter":{"title":"#4 NestJS GraphQL/Prisma/PostgreSQL 구성하기"}},"next":{"fields":{"slug":"/nestjs-passport-bcrypt로-guards-개선하기"},"frontmatter":{"title":"#6 Nestjs passport와 bcrypt로 Guard 개선하기"}}},"pageContext":{"locale":"ko","isDefaultLang":true,"slug":"/nestjs-guards-적용하기","titleByLang":{"ko":"nestjs-guards-적용하기","en":"nestjs-guards-setup"},"dateFormat":"YYYY년 MM월 DD일","id":"e05965db-d559-5d78-ac42-87b68b2a2748","previousPostId":"1404b0e5-ccd9-5a8d-adba-f20bc79b3753","nextPostId":"f561f6bd-0f28-597b-b1d9-02636f8034ab"}},"staticQueryHashes":[],"slicesMap":{}}