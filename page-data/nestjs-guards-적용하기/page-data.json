{"componentChunkName":"component---src-templates-blog-post-js","path":"/nestjs-guards-적용하기/","result":{"data":{"site":{"siteMetadata":{"title":"Seunghyun's Blog"}},"markdownRemark":{"id":"ca3048de-bc02-5d1f-ad11-48348cffb441","excerpt":"지난 글에서 Toilet, Address와 Review에 대해 CRUD 작업을 하는 Graphql…","html":"<p>지난 글에서 Toilet, Address와 Review에 대해 CRUD 작업을 하는 Graphql 서버를 구성했습니다. 이 어플리케이션으로 여러 사람으로부터 화장실에 대한 정보를 얻으려고 합니다. 하지만 임의의 사용자가 자신이 작성하지 않을 리뷰를 지우는 것을 허용하지 않아야 합니다. 이를 위해 <code class=\"language-text\">review</code> Resolver에 <strong>Guard</strong>를 적용할 것입니다.</p>\n<h2>Review Schema 수정</h2>\n<p><code class=\"language-text\">Review</code> 모델에 password 필드가 없었기 때문에 이 필드를 추가하고 <code class=\"language-text\">npx prisma migrate dev --create-only</code>라는 명령어를 통해 데이터베이스에 재등록을 시킵니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">model Review <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    contributedBy String   @unique\n    password      String\n    toiletId      String\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Review DTO 수정</h2>\n<p>리뷰를 남기는 사용자가 리뷰를 작성할 때 비밀번호와 함께 생성되도록 하여 해당 리뷰를 지우려고 할 때 누군지 확인할 수 있게 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// create-review.input.ts</span>\n@<span class=\"token function\">InputType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CreateReviewInput</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  toiletId<span class=\"token operator\">?</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">contributedBy</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">password</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음과 같이 delete-review input에도 password 필드를 추가합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// delete-review.input.ts</span>\n@<span class=\"token function\">InputType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DeleteReviewInput</span> <span class=\"token punctuation\">{</span>\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">contributedBy</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">password</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Guard 작성</h2>\n<p><code class=\"language-text\">src</code>폴더 하위에 <code class=\"language-text\">guards</code>라는 폴더를 생성하고 해당 폴더 하위에 <code class=\"language-text\">review.guard.ts</code>라는 파일을 만듭니다. <strong>Guard</strong>를 사용하면 요청 객체에서 정보를 얻어 이를 사용해 <strong>라우터 핸들러</strong>에서 처리해도 될지 말지를 결정할 수 있습니다. 간단하게 말해 authorization/authention이 이루어지는 곳이라고 봐도 되겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Injectable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ReviewAuthGuard</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">CanActivate</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">@<span class=\"token function\">Inject</span><span class=\"token punctuation\">(</span>ReviewsService<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token literal-property property\">reviewsService</span><span class=\"token operator\">:</span> ReviewsService</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">canActivate</span><span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> GqlExecutionContext<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>boolean<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> GqlExecutionContext<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> deleteReviewData <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">getArgs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> contributedBy<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> deleteReviewData<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> reviewInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>reviewsService<span class=\"token punctuation\">.</span><span class=\"token function\">getReview</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      reviewInfo<span class=\"token punctuation\">.</span>contributedBy <span class=\"token operator\">===</span> contributedBy <span class=\"token operator\">&amp;&amp;</span>\n      reviewInfo<span class=\"token punctuation\">.</span>password <span class=\"token operator\">===</span> password\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>주의: REST 대신 Graphql를 사용하므로 <strong>GqlExecutionContext</strong>를 import해야 합니다.</p>\n</blockquote>\n<p>이 가드는 delete review input이 담긴 인자(argument)를 얻고 이 안에 담긴 이메일과 비밀번호를 <code class=\"language-text\">reviewService</code>로 불러온 리뷰 정보에 담긴 이메일과 비밀번호와 비교합니다. 이 정보들이 일치한다면 해당 요청이 <strong>라우터 핸들러</strong>로 가게 됩니다.</p>\n<h2>UseGuards 데코레이터</h2>\n<p>마지막으로 이 가드를 사용하려면 <code class=\"language-text\">review</code> Resolver에 있는 대상 메소드 위에 <code class=\"language-text\">UseGuards</code> 데코레이터를 위치시키고 <code class=\"language-text\">ReviewAuthGuard</code>를 인자로 전달해야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Mutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Review<span class=\"token punctuation\">)</span>\n@<span class=\"token function\">UseGuards</span><span class=\"token punctuation\">(</span>ReviewAuthGuard<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token function\">deleteReview</span><span class=\"token punctuation\">(</span>\n  @<span class=\"token function\">Args</span><span class=\"token punctuation\">(</span><span class=\"token string\">'deleteReviewData'</span><span class=\"token punctuation\">)</span> deleteReviewData<span class=\"token operator\">:</span> DeleteReviewInput<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>Review<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>reviewService<span class=\"token punctuation\">.</span><span class=\"token function\">deleteReview</span><span class=\"token punctuation\">(</span>deleteReviewData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>테스트</h2>\n<h3>리뷰 생성</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0b81a702c0abf875be6612f3882a60b5/c54b3/create-review.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.45569620253164%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABlUlEQVR42qWR6XKbMBSF/QC2AXlpaBzQhhBhkZDATTx9/9c6HYnQZtqp0+XHpytGM9+cc9lk9Q1Z8xWpvoEoj4T1SOhCyhbWe3jb09/RxblJuAHpPI52xtFMOAweeTtDVg5NM6GqPWo9oX2eQZXHSY4gzEQO7zgyg4wO2ATrWRhI7VA3Hkx7XISDqF5B5QsKMUUu3IOJK0oxx+8nPqHgM6iYwcU1EqRReOIDlPaotI+TKou0umJXXWOVdQU/s9Z9f9/syh6P0sZ0onbQzYRCjTjIGZ+rFxA6YPe2n+3bTO4QE34SBlXtUCgLpV1Mmksb64SKD3zEkVnkzIFQc1e62Zc9ztwslRsHEWY9QagZTHxBLV+h5S3u7yKm+APuCsORq5DO4VJZnKVBWg7Imccj93jgLiY7MYstbT+uHI5MjdhLg+1Ti33RISk77GgbBWF/K8kHskVY9kjkANJ7ZHpE1jkQOyGrbRSnfyD5RZgqGyVknJB1HmllkIjhr0TfhSkdQKRFwoeF8FD2/ySLQiLsD8l/iFbhN7RKaZVNhZNKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"create-reivew\"\n        title=\"\"\n        src=\"/static/0b81a702c0abf875be6612f3882a60b5/f058b/create-review.png\"\n        srcset=\"/static/0b81a702c0abf875be6612f3882a60b5/c26ae/create-review.png 158w,\n/static/0b81a702c0abf875be6612f3882a60b5/6bdcf/create-review.png 315w,\n/static/0b81a702c0abf875be6612f3882a60b5/f058b/create-review.png 630w,\n/static/0b81a702c0abf875be6612f3882a60b5/c54b3/create-review.png 727w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>일치하는 비밀번호로 리뷰 지우기</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a86b031dfd80e0219996585f0f2a04e8/ace37/delete-review.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.43037974683544%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABeUlEQVR42q2R626jMBBG+wANYNKukjQBY2NDGm7mnvd/sFNBslGrXVXVan8ce/zneL6ZJ2FnRDohzBWhHEKW+FHBJi4/cXs/329/Qf6dp8D2hPUVUV8Jq4Hg4vDfHdI6TrZBZvfaNOjMsUtrAlWzkcWDZ1ngyeImXIqXvGF/cezynug883aesHYitxPGDijTY+1Ino0kZmCvO6QeOaqOk+5J9MhOObxVGJe8JBXKthy142xGcjtg84G96lB6QusZk145qgGjZ06q46A69qpdOaqebVLfhbLgl67I8o40bzHnlti22GwgSnu0nsjSK2k6r10tgiCp1phfI99nuBwH2yJtS5w2HHSDFxW8Rg2RHnhT3drBcr8mzSrw5HdLkSWhcXiZY5NWeFmDeHcEhXt0sW73PvjgG9ltKXGBb2q2/ci2HQnbAXFpCS9LtHIV/Mb/AWtkYRqCpbOzI7A1/vJJVPxI8Icw1DVCVjfBQlz+k+ghFKpijS3L/8IH72cyZsBrIRkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"delete-review\"\n        title=\"\"\n        src=\"/static/a86b031dfd80e0219996585f0f2a04e8/f058b/delete-review.png\"\n        srcset=\"/static/a86b031dfd80e0219996585f0f2a04e8/c26ae/delete-review.png 158w,\n/static/a86b031dfd80e0219996585f0f2a04e8/6bdcf/delete-review.png 315w,\n/static/a86b031dfd80e0219996585f0f2a04e8/f058b/delete-review.png 630w,\n/static/a86b031dfd80e0219996585f0f2a04e8/ace37/delete-review.png 666w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>일치하지 않는 비밀번호로 리뷰 응답</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 585px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/777c400960075915e9ad410001ab2d9f/78a22/delete-forbidden.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.39240506329114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABPklEQVR42p1T3U7DIBjdS6zwUU3U6cVaoGxuKx30Z0t0Zote+P7vcgzUuiV6YXdxwscHOZzDgUmqawhdY5ptkWRbTDMXR5Zfhwmbl0i1x8yUuCssHkyJe2NByoNLN55QyL6YLSwelxZPZo1bZUHSgQ8bs39gIAxKQpHkHkzWmKoOTLXgugFXNXg4sHBghQdf9GDKgRcBPiKsnS3/yK2ixdR+QJQnpNtPpJsjyDQg24FsC3IdyO964rIFVd/9TYtB2ERof7YmHWj5AlodQKs3iPUxzkNwPHdg86rHYPNy/lthSLmKJ4mi6ZPOKrBAJMek/EeTSw9avoKeDyBdg4r92cVowqBK1dGusO9INycIswfTu/GESVTnQCFd3YGbfY9w4aq5TmEIKbxBltkLVPEVjCP8DuTGtEhyBy7rq37KF491ZzmamK1PAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"delete-forbidden\"\n        title=\"\"\n        src=\"/static/777c400960075915e9ad410001ab2d9f/78a22/delete-forbidden.png\"\n        srcset=\"/static/777c400960075915e9ad410001ab2d9f/c26ae/delete-forbidden.png 158w,\n/static/777c400960075915e9ad410001ab2d9f/6bdcf/delete-forbidden.png 315w,\n/static/777c400960075915e9ad410001ab2d9f/78a22/delete-forbidden.png 585w\"\n        sizes=\"(max-width: 585px) 100vw, 585px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>정리</h2>\n<p><strong>Guard</strong>를 사용하여 사용자를 인증하면 그 인증 기능을 집중시켜 어플리케이션 전체에 사용할 수 있다는 것이 큰 매력입니다. 하지만 보시다시피 필자는 인증을 아주 단순하게 처리했습니다. 다음 글에서는 <code class=\"language-text\">passport</code>와 <code class=\"language-text\">bcrypt</code>를 사용하여 이 과정을 심화시켜 보겠습니다.</p>\n<p><em><strong>읽어 주셔서 감사합니다. To be continued!</strong></em></p>\n<h3>참조</h3>\n<ul>\n<li><a href=\"https://docs.nestjs.com/graphql/other-features\">https://docs.nestjs.com/graphql/other-features</a></li>\n<li><a href=\"https://docs.nestjs.com/guards\">https://docs.nestjs.com/guards</a></li>\n</ul>","frontmatter":{"title":"#5 리뷰 임의 삭제 방지를 위한 Guard 적용하기","date":"2023년 08월 02일","description":"","tag":["Project","NodeJS"]},"fields":{"locale":"ko"}},"previous":{"fields":{"slug":"/nestjs-graphql-prisma-postgresql-구성하기"},"frontmatter":{"title":"#4 NestJS GraphQL/Prisma/PostgreSQL 구성하기"}},"next":{"fields":{"slug":"/nestjs-passport-bcrypt로-guards-개선하기"},"frontmatter":{"title":"#6 Nestjs passport와 bcrypt로 Guard 개선하기"}}},"pageContext":{"locale":"ko","isDefaultLang":true,"slug":"/nestjs-guards-적용하기","titleByLang":{"ko":"nestjs-guards-적용하기","en":"nestjs-guards-setup"},"dateFormat":"YYYY년 MM월 DD일","id":"ca3048de-bc02-5d1f-ad11-48348cffb441","previousPostId":"6ebbfff5-1d1c-57ea-a9fc-522f6b75202b","nextPostId":"7507bc71-d607-5b2b-9641-2b62ddaec5fb"}},"staticQueryHashes":[],"slicesMap":{}}