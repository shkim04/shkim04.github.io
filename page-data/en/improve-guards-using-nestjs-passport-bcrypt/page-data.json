{"componentChunkName":"component---src-templates-blog-post-js","path":"/en/improve-guards-using-nestjs-passport-bcrypt/","result":{"data":{"site":{"siteMetadata":{"title":"Seunghyun's Blog"}},"markdownRemark":{"id":"0368bf23-3f6e-54ed-9b76-1d11a875458e","excerpt":"You can see the whole code on the nestjs-auth branch. I have implemented Guard and have it put on the delete method in  resolver so that no one can delete a…","html":"<p><em>You can see the whole code on the <a href=\"https://github.com/shkim04/find-your-wc/tree/nestjs-auth\">nestjs-auth</a> branch.</em></p>\n<p>I have implemented <strong>Guard</strong> and have it put on the delete method in <code class=\"language-text\">review</code> resolver so that no one can delete a review without being authenticated. However, it was too simple to be a proper strategy for authentication. We should improve the process for the sake of security. To do it, we will use <code class=\"language-text\">passport</code> and <code class=\"language-text\">bcrypt</code>.</p>\n<h2>Install dependencies</h2>\n<p>First, install all the relevant dependencies for <code class=\"language-text\">passport</code> and <code class=\"language-text\">bcrypt</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install --save @nestjs/passport passport passport-local\r\nnpm install --save-dev @types/passport-local\r\n\r\nnpm install bcrypt\r\nnpm install -D @types/bcrypt</code></pre></div>\n<p>As you can see, I used <strong>local</strong> for <code class=\"language-text\">passport</code> strategy. As I have looked briefly at the community so far, it seems like using both <strong>local</strong> and <strong>jwt</strong> for the strategy is a great practice for they could be complimentary to each other. I will look more into it later but, since all we have to do is to compare an input password to a password associated with a review in our database, we can just use <strong>local</strong> for now. I may take a further step on this if needed in the future.</p>\n<h2>Auth service</h2>\n<p>We will create <code class=\"language-text\">auth</code> service that has methods <code class=\"language-text\">validateContributor</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Injectable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthService</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">private</span> <span class=\"token literal-property property\">reviewsService</span><span class=\"token operator\">:</span> ReviewsService</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">validateContributor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reviewData</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> review <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>reviewsService<span class=\"token punctuation\">.</span><span class=\"token function\">getReview</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token literal-property property\">contributedBy</span><span class=\"token operator\">:</span> reviewData<span class=\"token punctuation\">.</span>contributedBy<span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> isMatch <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">comparePassword</span><span class=\"token punctuation\">(</span>\r\n      reviewData<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">,</span>\r\n      review<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isMatch<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> review<span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">// ...</span>\r\n\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">comparePassword</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">password<span class=\"token punctuation\">,</span> hash</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> isMatch <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> bcrypt<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">,</span> hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">return</span> isMatch<span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This will read the delete review input and check if there is a review that matches the input and compare passwords. We will use this method for <code class=\"language-text\">passport</code> strategy.</p>\n<h2>LocalStrategy</h2>\n<p>We will create <code class=\"language-text\">LocalStrategy</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Injectable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LocalStrategy</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">PassportStrategy</span><span class=\"token punctuation\">(</span>Strategy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">private</span> <span class=\"token literal-property property\">authService</span><span class=\"token operator\">:</span> AuthService</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">usernameField</span><span class=\"token operator\">:</span> <span class=\"token string\">'contributedBy'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">contributedBy<span class=\"token punctuation\">,</span> password</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> review <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>authService<span class=\"token punctuation\">.</span><span class=\"token function\">validateContributor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n      contributedBy<span class=\"token punctuation\">,</span>\r\n      password<span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>review<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UnauthorizedException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> review<span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>By default, local strategy reads <code class=\"language-text\">username</code>, <code class=\"language-text\">password</code> from request body. So, I needed to replace <code class=\"language-text\">username</code> with <code class=\"language-text\">contributedBy</code> by passing it in <code class=\"language-text\">super</code>.</p>\n<p><code class=\"language-text\">validate</code> method will take <code class=\"language-text\">contributedBy</code> and <code class=\"language-text\">password</code> from body object and will authenticate the user. If authenticated, it will allow the request to be handled by <strong>Router handler</strong>.</p>\n<h2>Graphql Guards</h2>\n<p>We will create <code class=\"language-text\">GqlAuthGuard</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Injectable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GqlAuthGuard</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AuthGuard</span><span class=\"token punctuation\">(</span><span class=\"token string\">'local'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> GqlExecutionContext<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> any <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> GqlExecutionContext<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> req <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> deleteReviewData <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">getArgs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    req<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> deleteReviewData<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">return</span> req<span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">@nestjs/passport</code> provides us with a build-in <strong>Guard</strong>. But, since we are using <strong>Graphql</strong>, we will  create our own Guard extended from the build-in Guard, <strong>AuthGuard</strong> and then, modify the context and body object of requests as shown above.</p>\n<p>Finally, we can put the <strong>GqlAuthGuard</strong> on the delete method in <code class=\"language-text\">review</code> resolver.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Mutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Review<span class=\"token punctuation\">)</span>\r\n@<span class=\"token function\">UseGuards</span><span class=\"token punctuation\">(</span>GqlAuthGuard<span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">async</span> <span class=\"token function\">deleteReview</span><span class=\"token punctuation\">(</span>\r\n  @<span class=\"token function\">Args</span><span class=\"token punctuation\">(</span><span class=\"token string\">'deleteReviewData'</span><span class=\"token punctuation\">)</span> deleteReviewData<span class=\"token operator\">:</span> DeleteReviewInput<span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>Review<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>reviewService<span class=\"token punctuation\">.</span><span class=\"token function\">deleteReview</span><span class=\"token punctuation\">(</span>deleteReviewData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Test</h2>\n<h3>Create a review</h3>\n<p>I created a review with a password saying <code class=\"language-text\">rightpassword</code>. It was hashed by using <code class=\"language-text\">bcrypt</code> and saved in database.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/55021c3d7cc4a4959752d476eb182d25/f3c12/create-review.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.746835443037973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAwklEQVR42p2OzW6DMBCE/RKVd7btIccQCAGMwX+YVEGQ5v3fJ7JRpJx6qDSH0cx+2hFUuY/CytN/JL7Ppuz7Qz2g8q/U/cW8fRLyZL6a+KnvrB+sN/QrNxGVk6VNeje7zlkv2MrSQa3c3tDP8Df2C8Yrxggzw1/hZoyRbPZ6SnkX9nUizSgs2gXdndWD1S/URtVEjacuQEcMkWpPbaBLSMdHIwsjj4kSskkFDwvbjYcV6odqu5OUK1JT8ipkPid7ePFPoak+Rpe17PcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"create-reivew\"\n        title=\"\"\n        src=\"/static/55021c3d7cc4a4959752d476eb182d25/f058b/create-review.png\"\n        srcset=\"/static/55021c3d7cc4a4959752d476eb182d25/c26ae/create-review.png 158w,\n/static/55021c3d7cc4a4959752d476eb182d25/6bdcf/create-review.png 315w,\n/static/55021c3d7cc4a4959752d476eb182d25/f058b/create-review.png 630w,\n/static/55021c3d7cc4a4959752d476eb182d25/f3c12/create-review.png 764w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Delete a review with wrong password</h3>\n<p>Notice that it throws <code class=\"language-text\">Unauthorized</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 544px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/80cc2b4b5f88abd79de81f17e4a4ca1b/b3e51/delete-unauthorized.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84.17721518987341%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAABjklEQVR42qVU7U7CMBT1IYD1tvBHxYRu6xjIPtqtDBADqImJ7/8sx7QjYiIamD9ObtI2J/ece09vRGIxkAa9iUZfavSkwUBqBGGJINRX4yaIDO7SHONZhnGa42GWYaQMKK67EQ5CjZEqMJ4VuJ9muJ3moLgCVxUCWXboMGylklqiH1r0Q/N1yeIaLDYI4uOZq5GGU+VrbM4TekwK0PwZQr+DZy8Q5gM8XYMpA6YbUL0CVStQ2YAyC7Ir0KMFReYXQlmC0g0oewX3ePFwZ0LVIGeBexfpU5X6jw7DVoqYbcCUBYvqYzWgSIOF5nIPv4PHBkwtWyQNWFQhiOrrhvIdA1mCTdegxR4iO4CUBU+3vtNOhG6hKX1qPcxfIfI3cCc92SK4QPYPwmFiOy30WUIeV2B+eoWX/j9CWWI034DcIJKVT4vfMfkPQjbdQBi32HvwxEKk9pgOc0rJVR5OCrBFBaobkEvHcn1KR9WcjdqfhENVgXn/cu/jF7pJLiAWO3CPg8+1A5/vQKpuf58LCD8BSJv9XQ5GvbEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"delete-unauthorized\"\n        title=\"\"\n        src=\"/static/80cc2b4b5f88abd79de81f17e4a4ca1b/b3e51/delete-unauthorized.png\"\n        srcset=\"/static/80cc2b4b5f88abd79de81f17e4a4ca1b/c26ae/delete-unauthorized.png 158w,\n/static/80cc2b4b5f88abd79de81f17e4a4ca1b/6bdcf/delete-unauthorized.png 315w,\n/static/80cc2b4b5f88abd79de81f17e4a4ca1b/b3e51/delete-unauthorized.png 544w\"\n        sizes=\"(max-width: 544px) 100vw, 544px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Delete a review with right password</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/49f4be4b6e5ef4fa15c9faa07fe22c44/9f21b/delete-authorized.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.139240506329116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA5ElEQVR42q2SUW7DIAyGe4kVzLYDjADtVMIazEiiVsrU3P88/wSp1qjantaHT7Il+5Ox2SiXsNURTzpCNhHin2xEw3g7BBjv8eIY0iYI3S00fCvWd9zL9I8wQjnGa/iCCjNUuIDaqfK8z5D2KjURosQFc2WdO641Vbgt0+xGqHYG7QcQn6DSGYpPIJ9B3QAKPYgH0LEHxZJnUBpBXQ95LAwglxZhQdoMdZhA72eQn6DaC9THDHKfkG1eBEWURkifF0K+Td+snkw2gSz/vuj1zsyq2fxxFGm4CsUDLlyF5ds8SlaE3yAM8HHDg5jmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"delete-authorized\"\n        title=\"\"\n        src=\"/static/49f4be4b6e5ef4fa15c9faa07fe22c44/f058b/delete-authorized.png\"\n        srcset=\"/static/49f4be4b6e5ef4fa15c9faa07fe22c44/c26ae/delete-authorized.png 158w,\n/static/49f4be4b6e5ef4fa15c9faa07fe22c44/6bdcf/delete-authorized.png 315w,\n/static/49f4be4b6e5ef4fa15c9faa07fe22c44/f058b/delete-authorized.png 630w,\n/static/49f4be4b6e5ef4fa15c9faa07fe22c44/9f21b/delete-authorized.png 706w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><em>You can see the whole code on the <a href=\"https://github.com/shkim04/find-your-wc/tree/nestjs-auth\">nestjs-auth</a> branch.</em></p>\n<p><em><strong>THANKS FOR READING. SEE YOU NEXT TIME!</strong></em></p>\n<h3>References</h3>\n<ul>\n<li><a href=\"https://docs.nestjs.com/recipes/passport\">https://docs.nestjs.com/recipes/passport</a></li>\n</ul>","frontmatter":{"title":"#6 Improve Guards using Nestjs passport and bcrypt","date":"04 Aug, 2023","description":"","tag":["Project","NodeJS"]},"fields":{"locale":"en"}},"previous":{"fields":{"slug":"/en/nestjs-guards-setup"},"frontmatter":{"title":"#5 Implement Guard for preventing a review from being deleted"}},"next":null},"pageContext":{"locale":"en","isDefaultLang":false,"slug":"/en/improve-guards-using-nestjs-passport-bcrypt","titleByLang":{"ko":"nestjs-passport-bcrypt로-guards-개선하기","en":"improve-guards-using-nestjs-passport-bcrypt"},"dateFormat":"DD MMM, YYYY","id":"0368bf23-3f6e-54ed-9b76-1d11a875458e","previousPostId":"ae028adf-6287-5d2f-bec4-8ff88bc6f087","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}