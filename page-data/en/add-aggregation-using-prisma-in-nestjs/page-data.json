{"componentChunkName":"component---src-templates-blog-post-js","path":"/en/add-aggregation-using-prisma-in-nestjs/","result":{"data":{"site":{"siteMetadata":{"title":"Seunghyun's Blog"}},"markdownRemark":{"id":"4f98109b-af6d-5c2f-9b8e-7ea66e3c323a","excerpt":"In our nextjs application, I would like to show some aggregated data such as the number of toilets, reviews, countries, etc stored in the database. In order to…","html":"<p>In our nextjs application, I would like to show some aggregated data such as the number of toilets, reviews, countries, etc stored in the database. In order to do this, we should add some feature to the backend server.</p>\n<blockquote>\n<p>For those who might read this article without reading the previous articles, You can find the whole backend code <a href=\"https://github.com/shkim04/find-your-wc\">here</a></p>\n</blockquote>\n<h2>Data Type</h2>\n<p>We will define the data types we would like bring into the nextjs application. Here is what it looks like in the backend:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Field<span class=\"token punctuation\">,</span> Int<span class=\"token punctuation\">,</span> ObjectType <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@nestjs/graphql'</span><span class=\"token punctuation\">;</span>\r\n\r\n@<span class=\"token function\">ObjectType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TotalAggregate</span> <span class=\"token punctuation\">{</span>\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Int<span class=\"token punctuation\">)</span>\r\n  <span class=\"token literal-property property\">numOfReviews</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">;</span>\r\n\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Int<span class=\"token punctuation\">)</span>\r\n  <span class=\"token literal-property property\">numOfToilets</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">;</span>\r\n\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Int<span class=\"token punctuation\">)</span>\r\n  <span class=\"token literal-property property\">numOfCountries</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">;</span>\r\n\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Int<span class=\"token punctuation\">)</span>\r\n  <span class=\"token literal-property property\">numOfCities</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">;</span>\r\n\r\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Int<span class=\"token punctuation\">)</span>\r\n  <span class=\"token literal-property property\">numOfStreets</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We will write this code in a file and place it under the <code class=\"language-text\">model</code> folder.</p>\n<h2>Add the feature in the repository layer</h2>\n<p>We will create a method called <strong>totalAggregate</strong> that gets all the relavant aggregated data using prisma API. Here is the code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Injectable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ToiletsRepository</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">private</span> <span class=\"token literal-property property\">prisma</span><span class=\"token operator\">:</span> PrismaService</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">// you can see the entire code on the repository mentioned above</span>\r\n\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">totalAggregate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>TotalAggregate<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>\r\n      toiletCount<span class=\"token punctuation\">,</span>\r\n      reviewCount<span class=\"token punctuation\">,</span>\r\n      countryGroupBy<span class=\"token punctuation\">,</span>\r\n      cityGroupBy<span class=\"token punctuation\">,</span>\r\n      streetGroupBy<span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\r\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>prisma<span class=\"token punctuation\">.</span>toilet<span class=\"token punctuation\">.</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">select</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">_all</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>prisma<span class=\"token punctuation\">.</span>review<span class=\"token punctuation\">.</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">select</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">_all</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>prisma<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">.</span><span class=\"token function\">groupBy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n        <span class=\"token literal-property property\">by</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'country'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token literal-property property\">_count</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">_all</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>prisma<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">.</span><span class=\"token function\">groupBy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n        <span class=\"token literal-property property\">by</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'city'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token literal-property property\">_count</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">_all</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>prisma<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">.</span><span class=\"token function\">groupBy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n        <span class=\"token literal-property property\">by</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'street'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token literal-property property\">_count</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">_all</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token literal-property property\">numOfToilets</span><span class=\"token operator\">:</span> toiletCount<span class=\"token punctuation\">.</span>_all<span class=\"token punctuation\">,</span>\r\n      <span class=\"token literal-property property\">numOfReviews</span><span class=\"token operator\">:</span> reviewCount<span class=\"token punctuation\">.</span>_all<span class=\"token punctuation\">,</span>\r\n      <span class=\"token literal-property property\">numOfCountries</span><span class=\"token operator\">:</span> countryGroupBy<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\r\n      <span class=\"token literal-property property\">numOfCities</span><span class=\"token operator\">:</span> cityGroupBy<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\r\n      <span class=\"token literal-property property\">numOfStreets</span><span class=\"token operator\">:</span> streetGroupBy<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Notice that I have used <code class=\"language-text\">Promise.All</code> to make the API calls concurrent. It is because I was not able to come up with any better solution than making a few of requests to get all those numbers. However, I do not think it involves a heavy computations so it seems good to go with this approach.</p>\n<h2>Add methods in the service layer and resolver layer</h2>\n<h3>Service layer</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Injectable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ToiletsService</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token parameter\"><span class=\"token keyword\">private</span> <span class=\"token literal-property property\">repository</span><span class=\"token operator\">:</span> ToiletsRepository<span class=\"token punctuation\">,</span>\r\n    @<span class=\"token function\">Inject</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CACHE_MANAGER</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token literal-property property\">cacheService</span><span class=\"token operator\">:</span> Cache<span class=\"token punctuation\">,</span></span>\r\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">// ...</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">totalAggregate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>TotalAggregate<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>repository<span class=\"token punctuation\">.</span><span class=\"token function\">totalAggregate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Resolver layer</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Resolver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Toilet<span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ToiletsResolver</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token parameter\"><span class=\"token keyword\">private</span> readonly toiletService<span class=\"token operator\">:</span> ToiletsService<span class=\"token punctuation\">,</span>\r\n    <span class=\"token keyword\">private</span> readonly addressService<span class=\"token operator\">:</span> AddressService<span class=\"token punctuation\">,</span>\r\n    <span class=\"token keyword\">private</span> readonly reviewsService<span class=\"token operator\">:</span> ReviewsService<span class=\"token punctuation\">,</span></span>\r\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">// ...</span>\r\n\r\n  @<span class=\"token function\">Query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> TotalAggregate<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'aggregate'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">getAggregate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>TotalAggregate<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>toiletService<span class=\"token punctuation\">.</span><span class=\"token function\">totalAggregate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">// ...</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Maybe, we can implement caching on the service layer and give it suitable expiration time soon.</p>\n<h2>Test</h2>\n<h3>Query</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 308px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b20074ba0ede5d602d0f187b5f9aeb0e/2ece4/aggregate-query.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.9367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAABtklEQVR42q2U3XKbMBCFeQJLIHGRTKcYbCfFMWA1QViAHafttA/Q93+W09lFTuwkpfY0FztaBBx9+6dATAuI5A4iLcH+tIA88i+1QBU/ENe/ocqfID9cWFzn9YtocqGgzAzkwkKka8ipgUgrhFkJkaxOPjyXOuBwsxX0rkX8awfdbqA6h/jbFrpzUL2DWhhc5RaTV4e8L3gguF0jMjWv8sb7S8O+nFcI5xVEWpwvOPl0B5kb6McO8WMHve+h3IaF1WbDpvuWDxAjpMHJBhFkJeSs8qSeigR4f7DzBD+vEBb30LuOKfVTD9U6RLaBbh000dYNoq819LZFVD3wP+OEREE5I7rcIFwahDl1wRpyUQ3hpiX7YladQbjyhAdrHVTTIDIPnFPtiXkI/hL2W0JPQpThl6HCnDda6f28HK32mxzGTz3ifT+s37dc8ai2UM7xM+WPDr6syvPqOY9M7I0ox8TeJ9xTD3ZMqWzDUxPdW+5BzmHdQHDrjAjSnIaZr9rM5ywdDnkmInLfo6OENJ8keLW0L7fLcQWTozX59+0TEBkJ/s8deCJ4vbQc7uQDxIb78IPIDoJ/ALPIEATIyRYmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aggregate-query\"\n        title=\"\"\n        src=\"/static/b20074ba0ede5d602d0f187b5f9aeb0e/2ece4/aggregate-query.png\"\n        srcset=\"/static/b20074ba0ede5d602d0f187b5f9aeb0e/c26ae/aggregate-query.png 158w,\n/static/b20074ba0ede5d602d0f187b5f9aeb0e/2ece4/aggregate-query.png 308w\"\n        sizes=\"(max-width: 308px) 100vw, 308px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Result</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 434px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/13d879f5a0268881353dd152182272c3/ade6e/aggregate-result.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.91139240506328%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAABiUlEQVR42q2U726CMBTFfQmhLer3IRQQFUoV47/ppm4z2d7/Uc5yL5jNTJmL+3DSpiS/nnt6Ly0ZTtH2Czj9Au1+tbp3qNXRBXo6R1cb9CIDGViIcHIHMMyR5ilGeYxolDCwG00h+gaubyrHvrkd6PgF3HAKNd5B2Q/IdAvPvEFle8jhFiqaoROdHP8Obrm1AxEv0LHvkOkjrwwcrKGSJUvqGURYwg3sDcD6dpEs4eUHeMWR3cnBqgJne6iohIyXUPGi0ek3oGV3KquAHMHomVcZL6o9gfUEMtlA6vJitudAKpFAlOG4zpCAdD56gkoWEOGsKv9K6ZcdmmOd4Qpe/sIw/qanEPEK1LvOlZf/6TDbwzOvLCpTphsogpJbBq4ZeC3HL2BQOxzvqgyzAxTByCmVPdxA6RIiWkIEk+ZHESfFc86Oc6NWIaUbvogeRoYTCD3nahoa20CGFp24hOPncB+ySrQ/k6nLbG7uFuUiz2bXXnBgbx89Djqwd/1hzoDkzvnD8N82y/+oT0h5AQpdS3N1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aggregate-result\"\n        title=\"\"\n        src=\"/static/13d879f5a0268881353dd152182272c3/ade6e/aggregate-result.png\"\n        srcset=\"/static/13d879f5a0268881353dd152182272c3/c26ae/aggregate-result.png 158w,\n/static/13d879f5a0268881353dd152182272c3/6bdcf/aggregate-result.png 315w,\n/static/13d879f5a0268881353dd152182272c3/ade6e/aggregate-result.png 434w\"\n        sizes=\"(max-width: 434px) 100vw, 434px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><em><strong>THANKS FOR READING. SEE YOU NEXT TIME!</strong></em></p>\n<h3>References</h3>\n<ul>\n<li><a href=\"https://www.prisma.io/docs/concepts/components/prisma-client/aggregation-grouping-summarizing\">https://www.prisma.io/docs/concepts/components/prisma-client/aggregation-grouping-summarizing</a></li>\n</ul>","frontmatter":{"title":"#13 Add aggregation using prisma in Nestjs","date":"24 Oct, 2023","description":"","tag":["Project","NodeJS"]},"fields":{"locale":"en"}},"previous":{"fields":{"slug":"/en/nextjs-update-data-approach-using-app-router"},"frontmatter":{"title":"#12 Nextjs update data approach using App router"}},"next":null},"pageContext":{"locale":"en","isDefaultLang":false,"slug":"/en/add-aggregation-using-prisma-in-nestjs","titleByLang":{"ko":"nestjs-prisma를-이용한-집계-추가하기","en":"add-aggregation-using-prisma-in-nestjs"},"dateFormat":"DD MMM, YYYY","id":"4f98109b-af6d-5c2f-9b8e-7ea66e3c323a","previousPostId":"24ba7bd9-cd58-5162-bc33-b6a2db2b1979","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}