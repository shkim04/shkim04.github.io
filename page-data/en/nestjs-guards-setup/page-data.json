{"componentChunkName":"component---src-templates-blog-post-js","path":"/en/nestjs-guards-setup/","result":{"data":{"site":{"siteMetadata":{"title":"Seunghyun's Blog"}},"markdownRemark":{"id":"9678a1bf-271b-5192-ab26-d3e698f7208d","excerpt":"In the last article, we have the core Graphql set, which can do CRUD for Toilet, Address and Review. With this application, we want to collect some information…","html":"<p>In the last article, we have the core Graphql set, which can do CRUD for Toilet, Address and Review. With this application, we want to collect some information about toilets from random people. But, we should not allow a random person to delete a review that is not written by the person. To achieve this goal, we will implement <strong>Guard</strong> on <code class=\"language-text\">review</code> resolver.</p>\n<h2>Modify Review Schema</h2>\n<p>Since we did not have password field in <code class=\"language-text\">Review</code> model, we will add the field and then, migrate to our database again by entering <code class=\"language-text\">npx prisma migrate dev --create-only</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">model Review <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    contributedBy String   @unique\n    password      String\n    toiletId      String\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Modify Review DTO</h2>\n<p>We should make a contributor create a reivew with a password so that we can identify who is trying to delete the review.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// create-review.input.ts</span>\n@<span class=\"token function\">InputType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CreateReviewInput</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  toiletId<span class=\"token operator\">?</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">contributedBy</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">password</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Add password field in the delete-review input type as shown below.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// delete-review.input.ts</span>\n@<span class=\"token function\">InputType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DeleteReviewInput</span> <span class=\"token punctuation\">{</span>\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">contributedBy</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n\n  @<span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token function\">IsNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">password</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Write Guard</h2>\n<p>We now will create a folder named <code class=\"language-text\">guards</code> under <code class=\"language-text\">src</code> folder. Inside of the folder, we will have a file named <code class=\"language-text\">review.guard.ts</code>. By using <strong>Guard</strong>, we can take the context of the incoming request and then, by using it, determine whether it is allowed to be handled by <strong>Router Handler</strong> or not. Simply put, it is where authorization/authentication happens.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Injectable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ReviewAuthGuard</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">CanActivate</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">@<span class=\"token function\">Inject</span><span class=\"token punctuation\">(</span>ReviewsService<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token literal-property property\">reviewsService</span><span class=\"token operator\">:</span> ReviewsService</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">canActivate</span><span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> GqlExecutionContext<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>boolean<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> GqlExecutionContext<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> deleteReviewData <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">getArgs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> contributedBy<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> deleteReviewData<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> reviewInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>reviewsService<span class=\"token punctuation\">.</span><span class=\"token function\">getReview</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      reviewInfo<span class=\"token punctuation\">.</span>contributedBy <span class=\"token operator\">===</span> contributedBy <span class=\"token operator\">&amp;&amp;</span>\n      reviewInfo<span class=\"token punctuation\">.</span>password <span class=\"token operator\">===</span> password\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Notice: Since we are using Graphql instead of REST, we should import <strong>GqlExecutionContext</strong>.</p>\n</blockquote>\n<p>The guard gets the arguemnt which contains the delete review input and compares the email and password to the corresponding ones from the review which is retrieved by <code class=\"language-text\">reviewService</code> injected. If they are matched, it will allow the request to go to <strong>Router handler</strong>.</p>\n<h2>UseGuards Decorator</h2>\n<p>At last, to make the guard work, we should pass <code class=\"language-text\">ReviewAuthGuard</code> in <code class=\"language-text\">UseGuards</code> decorator and put it on the top of the target method in <code class=\"language-text\">review</code> resolver.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Mutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Review<span class=\"token punctuation\">)</span>\n@<span class=\"token function\">UseGuards</span><span class=\"token punctuation\">(</span>ReviewAuthGuard<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token function\">deleteReview</span><span class=\"token punctuation\">(</span>\n  @<span class=\"token function\">Args</span><span class=\"token punctuation\">(</span><span class=\"token string\">'deleteReviewData'</span><span class=\"token punctuation\">)</span> deleteReviewData<span class=\"token operator\">:</span> DeleteReviewInput<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>Review<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>reviewService<span class=\"token punctuation\">.</span><span class=\"token function\">deleteReview</span><span class=\"token punctuation\">(</span>deleteReviewData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Test</h2>\n<h3>Create a review</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0b81a702c0abf875be6612f3882a60b5/c54b3/create-review.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.45569620253164%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABlUlEQVR42qWR6XKbMBSF/QC2AXlpaBzQhhBhkZDATTx9/9c6HYnQZtqp0+XHpytGM9+cc9lk9Q1Z8xWpvoEoj4T1SOhCyhbWe3jb09/RxblJuAHpPI52xtFMOAweeTtDVg5NM6GqPWo9oX2eQZXHSY4gzEQO7zgyg4wO2ATrWRhI7VA3Hkx7XISDqF5B5QsKMUUu3IOJK0oxx+8nPqHgM6iYwcU1EqRReOIDlPaotI+TKou0umJXXWOVdQU/s9Z9f9/syh6P0sZ0onbQzYRCjTjIGZ+rFxA6YPe2n+3bTO4QE34SBlXtUCgLpV1Mmksb64SKD3zEkVnkzIFQc1e62Zc9ztwslRsHEWY9QagZTHxBLV+h5S3u7yKm+APuCsORq5DO4VJZnKVBWg7Imccj93jgLiY7MYstbT+uHI5MjdhLg+1Ti33RISk77GgbBWF/K8kHskVY9kjkANJ7ZHpE1jkQOyGrbRSnfyD5RZgqGyVknJB1HmllkIjhr0TfhSkdQKRFwoeF8FD2/ySLQiLsD8l/iFbhN7RKaZVNhZNKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"create-reivew\"\n        title=\"\"\n        src=\"/static/0b81a702c0abf875be6612f3882a60b5/f058b/create-review.png\"\n        srcset=\"/static/0b81a702c0abf875be6612f3882a60b5/c26ae/create-review.png 158w,\n/static/0b81a702c0abf875be6612f3882a60b5/6bdcf/create-review.png 315w,\n/static/0b81a702c0abf875be6612f3882a60b5/f058b/create-review.png 630w,\n/static/0b81a702c0abf875be6612f3882a60b5/c54b3/create-review.png 727w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Delete a review with right password</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a86b031dfd80e0219996585f0f2a04e8/ace37/delete-review.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.43037974683544%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABeUlEQVR42q2R626jMBBG+wANYNKukjQBY2NDGm7mnvd/sFNBslGrXVXVan8ce/zneL6ZJ2FnRDohzBWhHEKW+FHBJi4/cXs/329/Qf6dp8D2hPUVUV8Jq4Hg4vDfHdI6TrZBZvfaNOjMsUtrAlWzkcWDZ1ngyeImXIqXvGF/cezynug883aesHYitxPGDijTY+1Ino0kZmCvO6QeOaqOk+5J9MhOObxVGJe8JBXKthy142xGcjtg84G96lB6QusZk145qgGjZ06q46A69qpdOaqebVLfhbLgl67I8o40bzHnlti22GwgSnu0nsjSK2k6r10tgiCp1phfI99nuBwH2yJtS5w2HHSDFxW8Rg2RHnhT3drBcr8mzSrw5HdLkSWhcXiZY5NWeFmDeHcEhXt0sW73PvjgG9ltKXGBb2q2/ci2HQnbAXFpCS9LtHIV/Mb/AWtkYRqCpbOzI7A1/vJJVPxI8Icw1DVCVjfBQlz+k+ghFKpijS3L/8IH72cyZsBrIRkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"delete-review\"\n        title=\"\"\n        src=\"/static/a86b031dfd80e0219996585f0f2a04e8/f058b/delete-review.png\"\n        srcset=\"/static/a86b031dfd80e0219996585f0f2a04e8/c26ae/delete-review.png 158w,\n/static/a86b031dfd80e0219996585f0f2a04e8/6bdcf/delete-review.png 315w,\n/static/a86b031dfd80e0219996585f0f2a04e8/f058b/delete-review.png 630w,\n/static/a86b031dfd80e0219996585f0f2a04e8/ace37/delete-review.png 666w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Reponse when deleting a review with wrong password</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 585px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/777c400960075915e9ad410001ab2d9f/78a22/delete-forbidden.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.39240506329114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABPklEQVR42p1T3U7DIBjdS6zwUU3U6cVaoGxuKx30Z0t0Zote+P7vcgzUuiV6YXdxwscHOZzDgUmqawhdY5ptkWRbTDMXR5Zfhwmbl0i1x8yUuCssHkyJe2NByoNLN55QyL6YLSwelxZPZo1bZUHSgQ8bs39gIAxKQpHkHkzWmKoOTLXgugFXNXg4sHBghQdf9GDKgRcBPiKsnS3/yK2ixdR+QJQnpNtPpJsjyDQg24FsC3IdyO964rIFVd/9TYtB2ERof7YmHWj5AlodQKs3iPUxzkNwPHdg86rHYPNy/lthSLmKJ4mi6ZPOKrBAJMek/EeTSw9avoKeDyBdg4r92cVowqBK1dGusO9INycIswfTu/GESVTnQCFd3YGbfY9w4aq5TmEIKbxBltkLVPEVjCP8DuTGtEhyBy7rq37KF491ZzmamK1PAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"delete-forbidden\"\n        title=\"\"\n        src=\"/static/777c400960075915e9ad410001ab2d9f/78a22/delete-forbidden.png\"\n        srcset=\"/static/777c400960075915e9ad410001ab2d9f/c26ae/delete-forbidden.png 158w,\n/static/777c400960075915e9ad410001ab2d9f/6bdcf/delete-forbidden.png 315w,\n/static/777c400960075915e9ad410001ab2d9f/78a22/delete-forbidden.png 585w\"\n        sizes=\"(max-width: 585px) 100vw, 585px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Thoughts</h2>\n<p>It is a cool thing to use <strong>Guard</strong> to authenticate a user because it has a single responsibility and can be used all over the whole application. But, as you can see, I had the simplest process for the authentication. In the next article, I will elaborate the process by making use of <code class=\"language-text\">passport</code> and <code class=\"language-text\">bcrypt</code> to hash passwords.</p>\n<p><em><strong>THANKS FOR READING. SEE YOU NEXT TIME!</strong></em></p>\n<h3>References</h3>\n<ul>\n<li><a href=\"https://docs.nestjs.com/graphql/other-features\">https://docs.nestjs.com/graphql/other-features</a></li>\n<li><a href=\"https://docs.nestjs.com/guards\">https://docs.nestjs.com/guards</a></li>\n</ul>","frontmatter":{"title":"#5 Implement Guard for preventing a review from being deleted","date":"02 Aug, 2023","description":"","tag":["Project","NodeJS"]},"fields":{"locale":"en"}},"previous":{"fields":{"slug":"/en/nestjs-graphql-prisma-postgresql-setup"},"frontmatter":{"title":"#4 NestJS GraphQL/Prisma/PostgreSQL Set Up"}},"next":{"fields":{"slug":"/en/improve-guards-using-nestjs-passport-bcrypt"},"frontmatter":{"title":"#6 Improve Guards using Nestjs passport and bcrypt"}}},"pageContext":{"locale":"en","isDefaultLang":false,"slug":"/en/nestjs-guards-setup","titleByLang":{"ko":"nestjs-guards-적용하기","en":"nestjs-guards-setup"},"dateFormat":"DD MMM, YYYY","id":"9678a1bf-271b-5192-ab26-d3e698f7208d","previousPostId":"74ad38e7-361d-5c42-804b-d5e86f4f4705","nextPostId":"fcf13f9c-de62-5f75-9fde-29be5f3d628b"}},"staticQueryHashes":[],"slicesMap":{}}