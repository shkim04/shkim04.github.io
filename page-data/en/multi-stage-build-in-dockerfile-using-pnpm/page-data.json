{"componentChunkName":"component---src-templates-blog-post-js","path":"/en/multi-stage-build-in-dockerfile-using-pnpm/","result":{"data":{"site":{"siteMetadata":{"title":"Seunghyun's Blog"}},"markdownRemark":{"id":"6931e698-ecb0-531a-98e7-391eefb85177","excerpt":"I chose to use npm as the package manager in the beginning as usual. But, I have changed it into pnpm and migrated it to this project since I was curious what…","html":"<p>I chose to use <strong>npm</strong> as the package manager in the beginning as usual. But, I have changed it into <strong>pnpm</strong> and migrated it to this project since I was curious what it is like - <em>pnpm is different from npm and could break the build system. In production, we definitely make sure to test it properly to swtich.</em></p>\n<p>I had to change <strong>Docker</strong> script for it was written for <strong>npm</strong>. Let me break down the Dockerfile that I have implemented.</p>\n<blockquote>\n<p>For those who might read this article without reading the previous articles, You can find the whole backend code <a href=\"https://github.com/shkim04/find-your-wc\">here</a></p>\n</blockquote>\n<h2>Development stage</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0c03facdffeb46f04279d9e0979fae24/fe8a7/development-stage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.44303797468354%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA00lEQVR42p2PW27DMAwEdZCYejimREWyJDsp0iRF73+qLawa/UqBph+DJYjFgFTn9o58u6NcHyjXD5RSsV4q1mVGCYwWPWoMKD39T7ZtJ75ThZEkYOQAFXODl4yQF7CcYIhgaYAlgrMGztqnjE922liomRM8CzhmhFThjhPseOxsBSL9O3pnn7XWUIEFIRfEsvSTJ0ngmMCS4DbpXvwrKssMKStO7dxFbpwwHA4gGqA1vS5s6YL57bFzR719Ygqxv/GqrAuFI3zMMMZ+Y13nP7JN+AVjKMZ+E8oVmgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"development-stage\"\n        title=\"\"\n        src=\"/static/0c03facdffeb46f04279d9e0979fae24/f058b/development-stage.png\"\n        srcset=\"/static/0c03facdffeb46f04279d9e0979fae24/c26ae/development-stage.png 158w,\n/static/0c03facdffeb46f04279d9e0979fae24/6bdcf/development-stage.png 315w,\n/static/0c03facdffeb46f04279d9e0979fae24/f058b/development-stage.png 630w,\n/static/0c03facdffeb46f04279d9e0979fae24/40601/development-stage.png 945w,\n/static/0c03facdffeb46f04279d9e0979fae24/fe8a7/development-stage.png 1223w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Installing <code class=\"language-text\">pnpm</code> is added to the script by writing <code class=\"language-text\">RUN wget -qO /bin/pnpm \"https://github.com/pnpm/pnpm/releases/latest/download/pnpm-linuxstatic-x64\" &amp;&amp; chmod +x /bin/pnpm</code>.</p>\n<p>Notice that instead of <strong>install</strong>, <strong>fetch</strong> is used for loading packages and it only requires <code class=\"language-text\">pnpm-lock.yaml</code> file - <em>I reason that <code class=\"language-text\">pnpm fetch</code> is equivalent to <code class=\"language-text\">npm ci</code> when you use <code class=\"language-text\">npm</code> for the build.</em></p>\n<p>According to the official document of <strong>pnpm</strong>, <code class=\"language-text\">pnpm fetch</code> and <code class=\"language-text\">pnpm install --offline</code> will save so much time.</p>\n<p>Lastly, since we use <strong>Prisma</strong> in the application, we should add <code class=\"language-text\">RUN pnpm exec prisma generate</code> to generate prisma client.</p>\n<h2>Build stage</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/78f279d415af6f7fd15acad423c019af/d9b5d/build-stage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.50632911392405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABJElEQVR42pWPW26DMBBF2UcCZvBjbGMbCGlD0qSpVKn739GtMCRK2p/242hm7PGVT7EfjoinN6Tpgm56R0odYnAIrNGyRrIGkU2eo9VLXc/nPmMUPDOkYRRtGMA+waUdjA8gIWCIYGQDIyVYLZgHnuZ1RzUNRE0ogm5htIVkB+MCapL5QhChEgJlWS5stwvrvF37qqruCCFQjH6HsJ/w8vGF3fkT3eGC4XhFf7rCdyMUW3CbYEMHG3to10JbD5cGKGPvQTeKyBG+36OfLgjjIWvPi41UIKKFRoKkzLWmJkNSoSZ6CsuBXRiRXs/w/QjjY35UbjaoqllHQMw/uCk9cJ9/BlrTgkOXtdjHXJV1aJT+pfMXipZDDpmV6nrVy2r077A58BttGuRs3irnCQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"build-stage\"\n        title=\"\"\n        src=\"/static/78f279d415af6f7fd15acad423c019af/f058b/build-stage.png\"\n        srcset=\"/static/78f279d415af6f7fd15acad423c019af/c26ae/build-stage.png 158w,\n/static/78f279d415af6f7fd15acad423c019af/6bdcf/build-stage.png 315w,\n/static/78f279d415af6f7fd15acad423c019af/f058b/build-stage.png 630w,\n/static/78f279d415af6f7fd15acad423c019af/40601/build-stage.png 945w,\n/static/78f279d415af6f7fd15acad423c019af/d9b5d/build-stage.png 1224w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>We can now copy <code class=\"language-text\">node_modules</code> folder created from the development stage. I have also copied <strong>.env</strong> file since it has some information when running the application.</p>\n<p>Finally by using <code class=\"language-text\">--prod</code> flag for installing packages after the build, Only production packages will be installed.</p>\n<h2>Production stage</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e99298f940617a5de8bbdbee98688ec5/681f1/production-stage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.88607594936709%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAzklEQVR42j2Q4W6EIBCEfY6KKByCKCDqnXq9tu//Vl8jufbHZGaTzWS/rcbeY2PAhJHejdgxYI3j5izKW5TrkUIgG0EjakT9UfySbBpaKYsXSUmV/UxvPfHxSdpfhPuTMd9xYSbvL+I1Lw+mdS87+flDOr6Yz2/8vJYDpu0gbGfJ1eIz1g6EdSfdj+JjWnFTJG1HKR9iZkhLyXE78XF5l020XYfSBqVvdEpTTdbjTEfoNUa1TEYRrMYbTa/+0C5cQVPXRdcL/pFbWVDbt34BFIl0vOYJQjkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"production-stage\"\n        title=\"\"\n        src=\"/static/e99298f940617a5de8bbdbee98688ec5/f058b/production-stage.png\"\n        srcset=\"/static/e99298f940617a5de8bbdbee98688ec5/c26ae/production-stage.png 158w,\n/static/e99298f940617a5de8bbdbee98688ec5/6bdcf/production-stage.png 315w,\n/static/e99298f940617a5de8bbdbee98688ec5/f058b/production-stage.png 630w,\n/static/e99298f940617a5de8bbdbee98688ec5/681f1/production-stage.png 899w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>In the production stage, we will simply copy <code class=\"language-text\">node_modules</code> and <code class=\"language-text\">dist</code> folders created from the build stage and then run the application.</p>\n<p>Once you enter the command <code class=\"language-text\">docker build -t [image-name-you-want-give] -f Dockerfile .</code> to build an image, the image will be created and you can see how fast it is created and how light it is - <em>You can build an image without implementing multi-stage build to compare.</em></p>\n<p><em><strong>THANKS FOR READING. SEE YOU NEXT TIME!</strong></em></p>\n<h3>References</h3>\n<ul>\n<li><a href=\"https://pnpm.io/cli/fetch\">https://pnpm.io/cli/fetch</a></li>\n</ul>","frontmatter":{"title":"#15 Multi-stage build in Dockerfile using pnpm","date":"03 Nov, 2023","description":"","tag":["Project"]},"fields":{"locale":"en"}},"previous":{"fields":{"slug":"/en/display-aggregated-data-in-nextjs"},"frontmatter":{"title":"#14 Display aggregated data in Nextjs application"}},"next":{"fields":{"slug":"/en/link-postgresql-redis-application-in-docker-compose"},"frontmatter":{"title":"#16 Link PostgresQL and Redis to Application in docker-compose"}}},"pageContext":{"locale":"en","isDefaultLang":false,"slug":"/en/multi-stage-build-in-dockerfile-using-pnpm","titleByLang":{"ko":"pnpm으로-dockerfile에서-multi-stage-빌드하기","en":"multi-stage-build-in-dockerfile-using-pnpm"},"dateFormat":"DD MMM, YYYY","id":"6931e698-ecb0-531a-98e7-391eefb85177","previousPostId":"61ebc2e4-7b2d-5edb-9f9e-7b5a7a617d8f","nextPostId":"d6cbb098-509d-5508-99e4-9bc1667cb20a"}},"staticQueryHashes":[],"slicesMap":{}}