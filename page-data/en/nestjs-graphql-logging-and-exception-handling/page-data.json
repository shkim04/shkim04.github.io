{"componentChunkName":"component---src-templates-blog-post-js","path":"/en/nestjs-graphql-logging-and-exception-handling/","result":{"data":{"site":{"siteMetadata":{"title":"Seunghyun's Blog"}},"markdownRemark":{"id":"da6d2ba4-0779-58e4-b2f8-1d26d9017550","excerpt":"It is crucial to know what is going on when an exception occurs within our application. NestJS comes along with a built-in exception layer where you can handle…","html":"<p>It is crucial to know what is going on when an exception occurs within our application. NestJS comes along with a built-in exception layer where you can handle exceptions. Since we have used Prisma, we will create <code class=\"language-text\">prisma exception-filter</code> to properly handle exceptions thrown by Prisma.</p>\n<h2>Create exception fitler</h2>\n<p>We will create <code class=\"language-text\">prisma-exception.filter.ts</code> under <code class=\"language-text\">excpetion-filters</code> folder. And write the follwing code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Catch</span><span class=\"token punctuation\">(</span>Prisma<span class=\"token punctuation\">.</span>PrismaClientKnownRequestError<span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PrismaClientExceptionFilter</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">GqlExceptionFilter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>exception<span class=\"token operator\">:</span> Prisma<span class=\"token punctuation\">.</span>PrismaClientKnownRequestError<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> any <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>exception<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'P2002'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConflictException</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Not Unique Email'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'P2003'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UnprocessableEntityException</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Entity Not Exist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'P2025'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Cannot find'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\r\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">return</span> exception<span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This exception filter will catch prism client request error as passed in <code class=\"language-text\">catch</code> decorator. It will throw execptions with suitable messages, which are corresponding to each of prisma error codes.</p>\n<p>Unlike REST API, we do not use <code class=\"language-text\">response</code> object and custom it to send clients back. Instead, we have thrown http exceptions so that <code class=\"language-text\">GraphQLModule</code> will pick these up and send them back to clients.</p>\n<p>Finally, we will make this filter global in <code class=\"language-text\">main.ts</code> - <em>you can just make it method-scoped or class-scoped</em>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">bootstrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">//..</span>\r\n\r\n  app<span class=\"token punctuation\">.</span><span class=\"token function\">useGlobalFilters</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PrismaClientExceptionFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">await</span> app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Format error for clients</h2>\n<p>To let clients know what went wrong nicely, we can format the error information before sending back.</p>\n<p>In <code class=\"language-text\">GraphQLModule</code>, we will format erros by adding <code class=\"language-text\">formatError</code> property which is a function returning a formatted error.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">GraphQLModule<span class=\"token punctuation\">.</span>forRootAsync<span class=\"token operator\">&lt;</span>ApolloDriverConfig<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// ...</span>\r\n  <span class=\"token function-variable function\">useFactory</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">config</span><span class=\"token operator\">:</span> ConfigService</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// ...</span>\r\n      <span class=\"token function-variable function\">formatError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">const</span> originalError <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>extensions\r\n          <span class=\"token operator\">?.</span>originalError <span class=\"token keyword\">as</span> OriginalError<span class=\"token punctuation\">;</span>\r\n\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>originalError<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span>\r\n            <span class=\"token literal-property property\">code</span><span class=\"token operator\">:</span> error<span class=\"token punctuation\">.</span>extensions<span class=\"token operator\">?.</span>code<span class=\"token punctuation\">,</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n\r\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> originalError<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span>\r\n          <span class=\"token literal-property property\">code</span><span class=\"token operator\">:</span> error<span class=\"token punctuation\">.</span>extensions<span class=\"token operator\">?.</span>code<span class=\"token punctuation\">,</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">// ...</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>For the sake of being concise, I wanted to send back an object containing only well-described message and apollo server error code.</p>\n<p>Notice that there is <code class=\"language-text\">originalError</code> property that I have tried to access. This is an object representing data about the exception thrown by an exception filter, which is here prisma exception filter.</p>\n<h2>Compare with and without formatting</h2>\n<h3>Without formatted error and exception filter</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/25b74ae59ef62971d3513ce36959688d/c8e86/without-formatting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.54430379746836%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAABxElEQVR42qVU227bMAz1T7QiUxR7K1DHl/hWW5Z8a7cMw/7/e85AyrETDAO69IGgRB8eUkeUI049HuIeD7GDOfZftug5s3gp3/BSNviWW0iBLxHSscdz7vGUeVDiYBIPIz6Vdb/aP7qPr/y6jiTxMXGg6oxD+1uNTxOoHsDdDLYzqB4DceZui4lPQ5zy8C2idtIkfhvBbgZ3YS9xkli/gNoRVA5gwfYBQ80IttOGo2oAZUKoSTPYL4G025O0kHTZXxWwUyAUknpQYio86ORXDVeQAtoAlk7o0o2spbpaIAn4aSds1iLlgEj0EbAm1iO4CR1rvBn3bi6k0o0cXzBCJp2JJb3qGGmwHEB2BdQruPBgKWDDkTddq2HVbw6FTn4rZpRQPqhuy3Y8PbZoJ5c0LEG3i1a5X72Dyb2SKGmxEuq1Jw5cfQfXZ3B1Vn/Iw63pqKTudt7+Mruto8uQcjqAsxEmHUAy3Ed3M7Cffin7xoKyGdz8wkG6zBeYO55hdL3hbAKXP3Cof4LzGSadtNBdhIfUg2KLx7iFibugy3+S7YSJw1P5ASo+VEdK7v+VRea1gxidZnDxDpYfRRo0NYkN3b5+3v4AW6wBPXYTFTsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"without-formatting\"\n        title=\"\"\n        src=\"/static/25b74ae59ef62971d3513ce36959688d/f058b/without-formatting.png\"\n        srcset=\"/static/25b74ae59ef62971d3513ce36959688d/c26ae/without-formatting.png 158w,\n/static/25b74ae59ef62971d3513ce36959688d/6bdcf/without-formatting.png 315w,\n/static/25b74ae59ef62971d3513ce36959688d/f058b/without-formatting.png 630w,\n/static/25b74ae59ef62971d3513ce36959688d/c8e86/without-formatting.png 758w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Clients will receive these bunch of information they might not need. Also, the message does not even look neat and intuitive.</p>\n<h3>With formmated error thrown by prisma exception filter</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 603px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f3b86cdfafa59c5bd8314e4f6dacbfbe/9128f/with-formatting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.69620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABPElEQVR42p2SwW6DMBBE8xPBayeVolZVCxgHUkKwjQHn0EOrHvL/HzOVIaRNlEoVh7XXc3iaXc9CKIdlYhAlBsvEDjdLNVhqZtWCZxbPxQFP+QEvuwqPRQ2ROZCcCYxSgwelsckNNqrCOqvBUwNKzi5jDRb64HyqoMXn/hYYjii1oMwhUh5M9aD8CNp6UNB3DqQsqGhAhQNt7XjnzaDfBU4l6i+szAlrc4Io3yHKFrw/gjce/NBCdEfw1o9v58F1D567K6cXIEk7OBP7D3DVgmUa3PTgugO3fnDI627U9u3YNx70dgcYYCvVgCX1uK/J9av+qWmf007jsx7fjBxg67wdovPn78k7vbzRL7+cGCRlBVWVQ2z41oOXnyDVXbv9b2xWyoFSDSE1SGowacFkMz/YYeRoiI6ZDfkN/AY3RkmVRQGCoAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"with-formatting\"\n        title=\"\"\n        src=\"/static/f3b86cdfafa59c5bd8314e4f6dacbfbe/9128f/with-formatting.png\"\n        srcset=\"/static/f3b86cdfafa59c5bd8314e4f6dacbfbe/c26ae/with-formatting.png 158w,\n/static/f3b86cdfafa59c5bd8314e4f6dacbfbe/6bdcf/with-formatting.png 315w,\n/static/f3b86cdfafa59c5bd8314e4f6dacbfbe/9128f/with-formatting.png 603w\"\n        sizes=\"(max-width: 603px) 100vw, 603px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Look at the suitable message with neatly formatted error.</p>\n<p><em><strong>THANKS FOR READING. SEE YOU NEXT TIME!</strong></em></p>\n<h3>References</h3>\n<ul>\n<li><a href=\"https://docs.nestjs.com/graphql/other-features\">https://docs.nestjs.com/graphql/other-features</a></li>\n<li><a href=\"https://stackoverflow.com/questions/61045881/why-arent-nestjs-graphql-validation-errors-placed-in-the-error-message-field\">https://stackoverflow.com/questions/61045881/why-arent-nestjs-graphql-validation-errors-placed-in-the-error-message-field</a></li>\n</ul>","frontmatter":{"title":"#9 Nestjs Graphql logging and exception handling","date":"31 Aug, 2023","description":"","tag":["Project","NodeJS"]},"fields":{"locale":"en"}},"previous":{"fields":{"slug":"/en/caching-with-nestjs-graphql-redis"},"frontmatter":{"title":"#8 Caching with Nestjs, Graphql and Redis"}},"next":null},"pageContext":{"locale":"en","isDefaultLang":false,"slug":"/en/nestjs-graphql-logging-and-exception-handling","titleByLang":{"ko":"nestjs-graphql-logging-예외-처리","en":"nestjs-graphql-logging-and-exception-handling"},"dateFormat":"DD MMM, YYYY","id":"da6d2ba4-0779-58e4-b2f8-1d26d9017550","previousPostId":"22b8f8e0-5999-58d7-bf20-6163370893eb","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}