{"componentChunkName":"component---src-templates-blog-post-js","path":"/en/2023-02-05/how-to-use-aws-sqs-nodejs/","result":{"data":{"site":{"siteMetadata":{"title":"Seunghyun's Blog"}},"markdownRemark":{"id":"991f63e0-85a9-58c6-a594-4f49f5813489","excerpt":"By the definition in the dictionary, queue for computing is a list of data items, commands, etc., stored so as to be retrievable in a definite order, usually…","html":"<p>By the definition in the dictionary, <strong>queue</strong> for computing is</p>\n<blockquote>\n<p>a list of data items, commands, etc., stored so as to be retrievable in a definite order, usually the order of insertion.</p>\n</blockquote>\n<p>I think this tells us a lot about what queue does in development. Queue lets you deal with things later, or retrieve them in other applications. When a service grows and as a result, its server needs to handle an enormous amount of requests or process intensive jobs, it is recommended to have more than one server, each of which has its own function.</p>\n<p>However, since all those servers might need to share a single source of data, the data should not be lost when communicating with each server. This is exactly where a queue messaging is needed. To see how a queue messaging works and practice in Node.js development, we will learn to use one of queue messaging services, AWS SQS on Node.js.</p>\n<h2>Prerequisite</h2>\n<ul>\n<li>Node</li>\n<li>VScode</li>\n<li>AWS account</li>\n<li>Insomnia</li>\n</ul>\n<h2>Use Scenario</h2>\n<p>Imagine that there is an e-commerce website like Amazon. Its server is expected to handle thousands of order requests and plus, it might send a response back to a client that contains information such as delivery status, mileage, personal recommendations, etc. If there are just 1000 requests to handle, then it is totally fine to do all these jobs in one single server. But, if there are 10,000,000 or 100,000,000 in split second, we have to run more than one server, each of which is in charge of a specific function.</p>\n<p>To imitate this scenario, we will have a server that handles purchase request from client and send the information to two queues we will create in the next step. Also, we will have two more servers which handles mileage and product tracking. These two servers are where the messages held in queues will be consumed.</p>\n<h2>Create Queues In AWS SQS</h2>\n<p>We should create queues that will receive messages from <strong>purchase</strong> server. One is for <strong>mileage</strong> server and the other is for <strong>product tracking</strong> server. To do that, Navigate to SQS. Click <em><strong>create</strong></em> queue and in the following page, give it a specific name related to what is expected to do, set <em><strong>encryption</strong></em> to disabled and leave the rest as default — it is fine for testing although there are a few of parameters you can change as you desire — Note that you should remember each url of the queues in the detail of the queues to use them for API.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/01c4c0721b2d25878f8724fd6b1d0f83/30c92/aws-sqs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.67088607594937%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACFklEQVR42o2S7UtTYRjGzx8SlmVSWm06N1+25ttyRzdzctZ28qWZM0JQsjCiD0UQaipkCoXQd9EvGkRQ0H/QpyiaouLZ5qZuflmtF3PHXzxn2mdvuLiu6+F5uXmuWyqzubhQVnssnLtop8kTZPjBE4aGH3H3/mODB+48ZGAoD2lsYgaXrFBcWk2p2UmJyfmfS0yXD+HkkqWegjPlPJuYIZXaYXl5hUhkGU3TEJXL5dD1HJLPH8JWI2Oy1GOpvIKposE4bLY2YLY2YqnKrwl9ssjC09Hn6LpOJpMhk/lONps1fP5CHckfCNPR1U+g4xZeXzdq5208bZ103Ointb0LRQ3jV/uocjRzotDM6Pg0f/f2SCYSpNO7pFIptre3SSaSxKJRJEddq9Fhpb2ZcpsLR/1VKu0y1ho34n+t1W5sdtnYc+psBWMT00Z33yIrbGhR1tY3WF1bR9OixGJxpGtqHz6lByXQi08J0aaEDG739+Dz96AEe/GrYWobfRQWWxkZf8H+n98kNI2dzTi7W0m24pvGI6Ik2aMie1WaWgK4PSrulqDhZe91vG1duD1BA3WudgpOmxmZfEX67QyRqZusvb7H6uwgqy8H2P/5g9zBAZII4CgIU0Vei4DMgg+90CIwkfLk1Cz8SrG3/gk9/gU99hk99pWjksSIHAdiDovOVxEKD7L47iPzS+9ZeCPwweC5hSXm5hf5BxvKrQyuj9UpAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aws-sqs\"\n        title=\"\"\n        src=\"/static/01c4c0721b2d25878f8724fd6b1d0f83/f058b/aws-sqs.png\"\n        srcset=\"/static/01c4c0721b2d25878f8724fd6b1d0f83/c26ae/aws-sqs.png 158w,\n/static/01c4c0721b2d25878f8724fd6b1d0f83/6bdcf/aws-sqs.png 315w,\n/static/01c4c0721b2d25878f8724fd6b1d0f83/f058b/aws-sqs.png 630w,\n/static/01c4c0721b2d25878f8724fd6b1d0f83/30c92/aws-sqs.png 874w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Practice</h2>\n<p>Install libraries that we need to practice and bring AWS SQS into our app.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install --save express dotenv aws-sdk sqs-consumer</code></pre></div>\n<blockquote>\n<p>sqs-consumer — Can build SQS-based applications without the boilerplate by just definining an async function that handles the SQS message processing.</p>\n</blockquote>\n<p>You can find a whole code that is discussed in this post — <a href=\"https://github.com/shkim04/sqs-scenario\">https://github.com/shkim04/sqs-scenario</a></p>\n<p>We will have the simplest servers so we can just focus on how to implement AWS SQS and what happens between servers with queue messages. For the sake of simplicity, we will create three folders that represents each server as mentioned, under the same project folder and name them <strong>purchase, mileage</strong> and <strong>productTracking</strong> respectively. Then, create <code class=\"language-text\">server.js</code> under each of the folders. Now, In <code class=\"language-text\">server.js</code> under <strong>purchase</strong> folder, we will have the code below:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./.env'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> aws <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aws-sdk'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> sqsClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">aws<span class=\"token punctuation\">.</span>SQS</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">region</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_REGION</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">accessKeyId</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_ACCESS_KEY_ID</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">secretAccessKey</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SECRET_ACCESS_KEY</span>\n  <span class=\"token comment\">// always recommended to save credentials in .env file</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_SQS_MILEAGE_URL</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SQS_MILEAGE_URL</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/purchase'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> username <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> price <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>price<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> mileageAccumulated <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>mileageAccumulated<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> trackingId <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>trackingId<span class=\"token punctuation\">;</span>\n \n  <span class=\"token keyword\">const</span> mileagePayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">'MessageBody'</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> id<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">username</span><span class=\"token operator\">:</span> username<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">mileageAccumulated</span><span class=\"token operator\">:</span> mileageAccumulated<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">price</span><span class=\"token operator\">:</span> price\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'QueueUrl'</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_SQS_MILEAGE_URL</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> trackingPayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">'MessageBody'</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> id<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">username</span><span class=\"token operator\">:</span> username<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">trackingId</span><span class=\"token operator\">:</span> trackingId\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'QueueUrl'</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> mileageResponse <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> sqsClient<span class=\"token punctuation\">.</span><span class=\"token function\">sendMessage</span><span class=\"token punctuation\">(</span>mileagePayload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> trackingReponse <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> sqsClient<span class=\"token punctuation\">.</span><span class=\"token function\">sendMessage</span><span class=\"token punctuation\">(</span>trackingPayload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>mileageResponse<span class=\"token punctuation\">,</span> trackingReponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Order Request Success'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'get /purchase error'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Order Request Fail From Server'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Server is running on </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>I assume that you already knew how to deal with environment variables and put the relevant keys and url for the code above by yourself.</p>\n<p>If you are all ready, enter <code class=\"language-text\">node ./purchase/server.js</code> to run <strong>purchase</strong> server. It is time to test the server with Insomnia by making a request to <code class=\"language-text\">/purchase</code> route and see if the message will be sent properly to the queue in SQS that we have just created.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 491px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7f69834c2120c9f3bd5f4baf3cc916c0/13566/insomnia.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkUlEQVR42oVTu24bMRC8L3ERCPcgeXzTvLdzJ9iKLKRw5TRxk1SuU7sK4MpFgHxO/iAfkM+ZYClLQQDLLgbLW94OZ3fITHCFsmQIwaNpGoQQEtq2Rdd1KTrnkOc5iqI4xrIo8W51htvNA358+4PH+994+PoLWS0UOBfQWqVCY8wRh2+lFKqqAuccjLG0ZowjL1a4Gu9w/+knvtw84fPH78ioIDYRWmvUdZ3UGWNTgfchkVKelBIOh8V4DikluKhQlCuU1QqM58goSXDOQhsFazVC0HBOJdW0R4SH/15aK6UhBB3a/SPURqKdDC4Wi8uNw3bnMU4ujYMKhRAnQfs0iqEfDoQKSknMHyyWnUfTNRi796llxioIwY+kFF8CEfZ9j2wvW0HpGsu1xbwJuJh7dJODjxLRD/A2QggGKeuTCsmoREhmEOjaDLPDvPEYFot5HbDdnWO97rG97jEvHm1nn7v5H1RPxOM47l2mRIzktIFWOg1ZSQ1jdDKGsF+fBqmcpmnfMrHTHXtt8G+ZQi3TQ/gLDlk/dp1VAaMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"insomnia\"\n        title=\"\"\n        src=\"/static/7f69834c2120c9f3bd5f4baf3cc916c0/13566/insomnia.png\"\n        srcset=\"/static/7f69834c2120c9f3bd5f4baf3cc916c0/c26ae/insomnia.png 158w,\n/static/7f69834c2120c9f3bd5f4baf3cc916c0/6bdcf/insomnia.png 315w,\n/static/7f69834c2120c9f3bd5f4baf3cc916c0/13566/insomnia.png 491w\"\n        sizes=\"(max-width: 491px) 100vw, 491px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The data above is the source of a queue message that purchase server will send to SQS. Click <em><strong>send</strong></em> and you will get logs looking like below in the terminal:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/72d5ee3930695ca6e2ed886160358cce/ef6b9/log-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.924050632911392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAn0lEQVR42mWOyw6CMBBF+RUJttNCBGeKlcSF8QEu9P8/55iicePiZu6ZzT1VMsNUGVNitIR4QVVJyeh3PT56oraEIRL3EdkJrRUOhD6sv8Lleu+pXs8Xj+XBPM/clxt6VA6XzDRP5GtGz4pdE3ox0n1ceTgNSCc4cbjg8K1nW7pzVGZGzpkQP4vd2K3r0gtSLL5mPxNtaVxDvan/U9e8AYmGXOlxabuhAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"log-1\"\n        title=\"\"\n        src=\"/static/72d5ee3930695ca6e2ed886160358cce/f058b/log-1.png\"\n        srcset=\"/static/72d5ee3930695ca6e2ed886160358cce/c26ae/log-1.png 158w,\n/static/72d5ee3930695ca6e2ed886160358cce/6bdcf/log-1.png 315w,\n/static/72d5ee3930695ca6e2ed886160358cce/f058b/log-1.png 630w,\n/static/72d5ee3930695ca6e2ed886160358cce/ef6b9/log-1.png 832w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>We have successfully sent the messages!</p>\n<p>To make <strong>mileage</strong> and <strong>productTracking</strong> server consume the messages, We will have the code in <code class=\"language-text\">server.js</code> under mileage folder:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./.env'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> Consumer <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sqs-consumer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_SQS_MILEAGE_URL</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SQS_MILEAGE_URL</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> mileageConsumerApp <span class=\"token operator\">=</span> Consumer<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">queueUrl</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_SQS_MILEAGE_URL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">handleMessage</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">message</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> messageBody <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> mileageInfo <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>messageBody<span class=\"token punctuation\">.</span>mileageAccumulated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> price <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>messageBody<span class=\"token punctuation\">.</span>price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> newMileage <span class=\"token operator\">=</span> mileageInfo <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>price <span class=\"token operator\">*</span> <span class=\"token number\">0.02</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"newMileage:\"</span><span class=\"token punctuation\">,</span> newMileage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmileageConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmileageConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'processing_error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmileageConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And in <code class=\"language-text\">server.js</code> under <strong>productTracking</strong> folder — <em>Notice that both servers do not have the same queue url</em>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./.env'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> Consumer <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sqs-consumer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> productTrackingConsumerApp <span class=\"token operator\">=</span> Consumer<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">queueUrl</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">handleMessage</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">message</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> messageBody <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> productTrackingId <span class=\"token operator\">=</span> messageBody<span class=\"token punctuation\">.</span>trackingId<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// tracking logic here</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"productTrackingId:\"</span><span class=\"token punctuation\">,</span> productTrackingId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nproductTrackingConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nproductTrackingConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'processing_error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nproductTrackingConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Open two more terminals and then run both servers. Both servers will receive messages from SQS and will be ready to process the data stored in them. To see what really happens, we will make the same request to <code class=\"language-text\">/purchase</code> route with Insomnia. Check out the logs in each of the terminals.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 320px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b71dcd63a810d4214950a42b40de2e6e/72799/log-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.78481012658228%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJElEQVR42k2Q2U7CYBCF+xQEQvdWkWBKoS2JQtu/bGXpYo1BIHpl1Gt8/+QzrTF68WVOzkxOJkcajVyCIGC72XJ4OjC9v8MwDEQ857GsSOKEIi+oqqpBxBG73Y5tuiERCdk+w/fGhKEgERHSYDDAcRyESFgtl7iuy3g8Jl2nPBRVM8ui5Hw+cT4dWcwT8jxns06b+2yXMZtNWa1Tlos5kqqqyLJMu92m3emgKAqarjdeTf1tt6vSaskNmmagKBq6rjc7TdMwTbPRtScNh0N8PyCKIsIwxPM86homwYSh42DZFtPwmqzok5d9XNfG868wTQvL+qEO/NXSy8sr5+OJqizJ93nTyfH5yNflwn6bYts2WXHD++ctbx8DhOgRJz1M4y/kP99v5qPPFeHGAAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"log-2\"\n        title=\"\"\n        src=\"/static/b71dcd63a810d4214950a42b40de2e6e/72799/log-2.png\"\n        srcset=\"/static/b71dcd63a810d4214950a42b40de2e6e/c26ae/log-2.png 158w,\n/static/b71dcd63a810d4214950a42b40de2e6e/6bdcf/log-2.png 315w,\n/static/b71dcd63a810d4214950a42b40de2e6e/72799/log-2.png 320w\"\n        sizes=\"(max-width: 320px) 100vw, 320px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 448px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e402758ca737104204aba488a79d4c3c/33b38/log-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.822784810126581%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmUlEQVR42l2OsQ6DMAxE+RUgyQAtDAygOImdJm2l8v/fc1UslaHD2efTWXrdNE849h3v1xu3ecZx7OCUUEtBjAmBCCJZfeuICFKIiCFi2zYQEZy16PsewzCga8NaC2OMbufc5cdxvPTLVMbo/a/W65gZWTLKoyBQULpGJMw4P6dm67qCE+NZK7wnkPfIOaP91lpBnpR4We74AtpYX71GohuuAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"log-3\"\n        title=\"\"\n        src=\"/static/e402758ca737104204aba488a79d4c3c/33b38/log-3.png\"\n        srcset=\"/static/e402758ca737104204aba488a79d4c3c/c26ae/log-3.png 158w,\n/static/e402758ca737104204aba488a79d4c3c/6bdcf/log-3.png 315w,\n/static/e402758ca737104204aba488a79d4c3c/33b38/log-3.png 448w\"\n        sizes=\"(max-width: 448px) 100vw, 448px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>You can see the data made in Insomnia and they are processed in each of two servers as desired. It worked well!</p>\n<h2>Conclusion</h2>\n<p>Queue messaging gives us a great ability to handle unexpected circumstances when there are an enormous amount of data, requests or such. Although SQS is a great solution, it is not only way to apply queue messaging to your application. So, I hope you also find other solutions as well and see what fits the best for your application or elaborate what you have learned in the post.</p>\n<p><em><strong>THANKS FOR READING. SEE YOU NEXT TIME!</strong></em></p>\n<p><em>This is originally posted on my <a href=\"https://medium.com/@shkim04/how-to-use-aws-sqs-on-node-js-e932fea9f2ef\">Medium</a>.</em>\n<em>Let's connect!</em></p>","frontmatter":{"title":"How To Use AWS SQS On Node.js","date":"05 Feb, 2023","description":"","tag":["Cloud","NodeJS"]},"fields":{"locale":"en"}},"previous":{"fields":{"slug":"/en/2023-01-30/pandas-for-excel-python"},"frontmatter":{"title":"How To Use Pandas For Excel On Python"}},"next":{"fields":{"slug":"/en/2023-02-07/how-to-use-google-error-reporting-nodejs"},"frontmatter":{"title":"How To Use Google Error Reporting On Node.js"}}},"pageContext":{"locale":"en","isDefaultLang":false,"slug":"/en/2023-02-05/how-to-use-aws-sqs-nodejs","titleByLang":{"ko":"nodejs-aws-sqs-사용하기","en":"how-to-use-aws-sqs-nodejs"},"dateFormat":"DD MMM, YYYY","id":"991f63e0-85a9-58c6-a594-4f49f5813489","previousPostId":"e14662e2-85ec-54ab-8416-11c2da342de1","nextPostId":"f0ab8fea-1b3c-5ce8-b8fc-70fc0c9618f3"}},"staticQueryHashes":[],"slicesMap":{}}