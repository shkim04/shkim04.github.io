{"componentChunkName":"component---src-templates-blog-post-js","path":"/nestjs-graphql-logging-예외-처리/","result":{"data":{"site":{"siteMetadata":{"title":"Seunghyun's Blog"}},"markdownRemark":{"id":"bcce5e69-c13b-54b5-9480-800208fc2b80","excerpt":"어플리케이션에 예외가 일어난 경우 어떤 예외가 발생했는지 아는 것이 중요합니다. NestJS는 이 예외들을 처리해주는 예외 층(layer)이 내장되어 있습니다. Prisma를 사용하고 있기 때문에 Prisma…","html":"<p>어플리케이션에 예외가 일어난 경우 어떤 예외가 발생했는지 아는 것이 중요합니다. NestJS는 이 예외들을 처리해주는 예외 층(layer)이 내장되어 있습니다. Prisma를 사용하고 있기 때문에 Prisma로부터 발생하는 예외를 적절하게 처리하기 위해 <code class=\"language-text\">prisma exception-filter</code>를 생성해보겠습니다.</p>\n<h2>예외 필터 생성</h2>\n<p><code class=\"language-text\">excpetion-filters</code> 폴더 하위에 <code class=\"language-text\">prisma-exception.filter.ts</code>를 생성합니다. 그리고 다음 코드를 작성할 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Catch</span><span class=\"token punctuation\">(</span>Prisma<span class=\"token punctuation\">.</span>PrismaClientKnownRequestError<span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PrismaClientExceptionFilter</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">GqlExceptionFilter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>exception<span class=\"token operator\">:</span> Prisma<span class=\"token punctuation\">.</span>PrismaClientKnownRequestError<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> any <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>exception<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'P2002'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConflictException</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Not Unique Email'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'P2003'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UnprocessableEntityException</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Entity Not Exist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'P2025'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Cannot find'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\r\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">return</span> exception<span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 예외 필터는 <code class=\"language-text\">catch</code> 데코레이터에 전달된 prisma 클라이언트 요청 에러를 잡습니다. 각 prisma 에러 코드에 맞는 알맞는 메시지와 함께 예외를 발생시킬 것입니다.</p>\n<p>REST API와는 달리 <code class=\"language-text\">response</code> 객체를 사용하여 커스텀하고 클라이언트로 전송하지 않습니다. 대신에 http 예외를 발생시켜 <code class=\"language-text\">GraphQLModule</code>이 이 예외를 클라이언트에 보내주게 됩니다.</p>\n<p>마지막으로 <code class=\"language-text\">main.ts</code>에서 이 필터를 전역으로 사용할 수 있게 만듭니다 - <em>메소드 혹은 클래스에 국한하여 사용할 수도 있습니다</em>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">bootstrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">//..</span>\r\n\r\n  app<span class=\"token punctuation\">.</span><span class=\"token function\">useGlobalFilters</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PrismaClientExceptionFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">await</span> app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>클라이언트를 위한 에러 포맷</h2>\n<p>클라이언트에 무엇이 잘못했는지 잘 전달하기 위해 응답을 보내기 전에 에러를 커스텀할 수 있습니다.</p>\n<p><code class=\"language-text\">GraphQLModule</code> 하위에 포맷이 된 에러를 반환하는 <code class=\"language-text\">formatError</code> 함수를 사용하면 가능합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">GraphQLModule<span class=\"token punctuation\">.</span>forRootAsync<span class=\"token operator\">&lt;</span>ApolloDriverConfig<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// ...</span>\r\n  <span class=\"token function-variable function\">useFactory</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">config</span><span class=\"token operator\">:</span> ConfigService</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// ...</span>\r\n      <span class=\"token function-variable function\">formatError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">const</span> originalError <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>extensions\r\n          <span class=\"token operator\">?.</span>originalError <span class=\"token keyword\">as</span> OriginalError<span class=\"token punctuation\">;</span>\r\n\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>originalError<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span>\r\n            <span class=\"token literal-property property\">code</span><span class=\"token operator\">:</span> error<span class=\"token punctuation\">.</span>extensions<span class=\"token operator\">?.</span>code<span class=\"token punctuation\">,</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n\r\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> originalError<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span>\r\n          <span class=\"token literal-property property\">code</span><span class=\"token operator\">:</span> error<span class=\"token punctuation\">.</span>extensions<span class=\"token operator\">?.</span>code<span class=\"token punctuation\">,</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">// ...</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>간결하고 명확함을 위해 필자는 알맞은 메시지 apollo 서버 에러 코드만을 담은 객체를 전송하고자 합니다.</p>\n<p><code class=\"language-text\">originalError</code>라는 필드를 확인할 수 있습니다. 이 필드는 prisma 예외 필터에서 발생한 예외들에 대한 데이터를 담고 있습니다.</p>\n<h2>비교</h2>\n<h3>예외 필터와 포맷 에러가 없는 경우</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/25b74ae59ef62971d3513ce36959688d/c8e86/without-formatting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.54430379746836%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAABxElEQVR42qVU227bMAz1T7QiUxR7K1DHl/hWW5Z8a7cMw/7/e85AyrETDAO69IGgRB8eUkeUI049HuIeD7GDOfZftug5s3gp3/BSNviWW0iBLxHSscdz7vGUeVDiYBIPIz6Vdb/aP7qPr/y6jiTxMXGg6oxD+1uNTxOoHsDdDLYzqB4DceZui4lPQ5zy8C2idtIkfhvBbgZ3YS9xkli/gNoRVA5gwfYBQ80IttOGo2oAZUKoSTPYL4G025O0kHTZXxWwUyAUknpQYio86ORXDVeQAtoAlk7o0o2spbpaIAn4aSds1iLlgEj0EbAm1iO4CR1rvBn3bi6k0o0cXzBCJp2JJb3qGGmwHEB2BdQruPBgKWDDkTddq2HVbw6FTn4rZpRQPqhuy3Y8PbZoJ5c0LEG3i1a5X72Dyb2SKGmxEuq1Jw5cfQfXZ3B1Vn/Iw63pqKTudt7+Mruto8uQcjqAsxEmHUAy3Ed3M7Cffin7xoKyGdz8wkG6zBeYO55hdL3hbAKXP3Cof4LzGSadtNBdhIfUg2KLx7iFibugy3+S7YSJw1P5ASo+VEdK7v+VRea1gxidZnDxDpYfRRo0NYkN3b5+3v4AW6wBPXYTFTsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"without-formatting\"\n        title=\"\"\n        src=\"/static/25b74ae59ef62971d3513ce36959688d/f058b/without-formatting.png\"\n        srcset=\"/static/25b74ae59ef62971d3513ce36959688d/c26ae/without-formatting.png 158w,\n/static/25b74ae59ef62971d3513ce36959688d/6bdcf/without-formatting.png 315w,\n/static/25b74ae59ef62971d3513ce36959688d/f058b/without-formatting.png 630w,\n/static/25b74ae59ef62971d3513ce36959688d/c8e86/without-formatting.png 758w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>클라이언트는 필요 이상의 정보를 받을 것이고 메시지는 간결하지도 직관적이지도 않습니다.</p>\n<h3>예외 필터와 포맷 에러가 있는 경우</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 603px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f3b86cdfafa59c5bd8314e4f6dacbfbe/9128f/with-formatting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.69620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABPElEQVR42p2SwW6DMBBE8xPBayeVolZVCxgHUkKwjQHn0EOrHvL/HzOVIaRNlEoVh7XXc3iaXc9CKIdlYhAlBsvEDjdLNVhqZtWCZxbPxQFP+QEvuwqPRQ2ROZCcCYxSgwelsckNNqrCOqvBUwNKzi5jDRb64HyqoMXn/hYYjii1oMwhUh5M9aD8CNp6UNB3DqQsqGhAhQNt7XjnzaDfBU4l6i+szAlrc4Io3yHKFrw/gjce/NBCdEfw1o9v58F1D567K6cXIEk7OBP7D3DVgmUa3PTgugO3fnDI627U9u3YNx70dgcYYCvVgCX1uK/J9av+qWmf007jsx7fjBxg67wdovPn78k7vbzRL7+cGCRlBVWVQ2z41oOXnyDVXbv9b2xWyoFSDSE1SGowacFkMz/YYeRoiI6ZDfkN/AY3RkmVRQGCoAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"with-formatting\"\n        title=\"\"\n        src=\"/static/f3b86cdfafa59c5bd8314e4f6dacbfbe/9128f/with-formatting.png\"\n        srcset=\"/static/f3b86cdfafa59c5bd8314e4f6dacbfbe/c26ae/with-formatting.png 158w,\n/static/f3b86cdfafa59c5bd8314e4f6dacbfbe/6bdcf/with-formatting.png 315w,\n/static/f3b86cdfafa59c5bd8314e4f6dacbfbe/9128f/with-formatting.png 603w\"\n        sizes=\"(max-width: 603px) 100vw, 603px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>잘 포맷된 에러와 함꼐 알맞은 메시지가 전달되었습니다.</p>\n<p><em><strong>읽어 주셔서 감사합니다. To be continued!</strong></em></p>\n<h3>참조</h3>\n<ul>\n<li><a href=\"https://docs.nestjs.com/techniques/caching\">https://docs.nestjs.com/techniques/caching</a></li>\n<li><a href=\"https://www.tomray.dev/nestjs-caching-redis\">https://www.tomray.dev/nestjs-caching-redis</a></li>\n</ul>","frontmatter":{"title":"#9 Nestjs Graphql logging과 예외 처리","date":"2023년 08월 31일","description":"","tag":["Project","NodeJS"]},"fields":{"locale":"ko"}},"previous":{"fields":{"slug":"/nestjs-graphql-redis로-캐싱하기"},"frontmatter":{"title":"#8 Nestjs, Graphql과 Redis로 캐싱하기 "}},"next":null},"pageContext":{"locale":"ko","isDefaultLang":true,"slug":"/nestjs-graphql-logging-예외-처리","titleByLang":{"ko":"nestjs-graphql-logging-예외-처리","en":"nestjs-graphql-logging-and-exception-handling"},"dateFormat":"YYYY년 MM월 DD일","id":"bcce5e69-c13b-54b5-9480-800208fc2b80","previousPostId":"38a4ae8c-8ace-501a-9644-b1569c6135a4","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}