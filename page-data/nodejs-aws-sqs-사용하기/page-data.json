{"componentChunkName":"component---src-templates-blog-post-js","path":"/nodejs-aws-sqs-사용하기/","result":{"data":{"site":{"siteMetadata":{"title":"Seunghyun's Blog"}},"markdownRemark":{"id":"cf7f4615-3f05-590c-a145-1e742cd08f9f","excerpt":"사전적 의미로 컴퓨터에서 의미하는 queue는 다음과 같다 a list of data items, commands, etc., stored so as to be retrievable in a definite order, usually the order of insertion…","html":"<p>사전적 의미로 컴퓨터에서 의미하는 <strong>queue</strong>는 다음과 같다</p>\n<blockquote>\n<p>a list of data items, commands, etc., stored so as to be retrievable in a definite order, usually the order of insertion.</p>\n</blockquote>\n<p>필자는 이 정의가 개발에서 말하는 queue에 대해 많은 것을 설명할 수 있다고 생각한다. Queue는 처리를 나중에 가능하게 하며 다른 어플리케이션에서 그 처리 데이터를 불러올 수 있다. 서비스가 커지고 그 결과로 서버가 처리해야 하는 요청의 수나 처리 복잡도가 증가할 때, 하나 이상의 서버를 가지고 서버에 각각 다른 기능을 부여해야 할지도 모른다.</p>\n<p>하지만, 모든 서버가 동일한 원천의 데이터를 필요하기 때문에 서버들 간의 통신에서 손실이 있어서는 안된다. 이러한 시나리오에서 queue 메시징이 필요하다. queue 메시징이 Node.js에서 어떻게 동작하는지 자주 쓰이는 queue 메시징 서비스 중 하나인 AWS SQS를 통해 알아보자.</p>\n<h2>필수</h2>\n<ul>\n<li>Node</li>\n<li>VScode</li>\n<li>AWS account</li>\n<li>Insomnia</li>\n</ul>\n<h2>시나리오</h2>\n<p>Amazon같은 이커머스 웹사이트가 있다고 가정하자. 서버가 무수히 많은 주문 요청을 받고 배달, 마일리지, 개인화 추천같은 응답을 일일이 보내주는 상황이 그려질 것이다. 만약 1000개의 요청을 다룬다면 하나의 서버로 처리하는 건 문제가 없을 수 있다. 만약 ms당 10,000,000 혹은 100,000,000 개를 처리해야 한다면 스케일 업을 해야 한다.</p>\n<p>이 시나리오를 간략하게 구현하기 위해 클라이언트에서 구매 요청을 받는 서버를 만든 후 이 정보를 두 개의 다른 queue에 보내게 한다. 또 마일리지와 상품 추적을 담당할 두 개의 서버를 만든다. 이 두 서버가 처음에 보낸 queue로 전달한 메시지가 사용되는 지점이다.</p>\n<h2>AWS SQS Queue 생성</h2>\n<p><strong>purchase</strong> 서버로부터 메시지를 받는 Queue를 생성하려고 한다. 하나는 <strong>mileage</strong> 서버용이고 다른 하나는 <strong>product tracking</strong> 서버용이다. AWS 콘솔에 로그인하여 SQS로 페이지를 이동한다. <em><strong>create</strong></em> queue를 누르고 queue의 역할에 맞는 특정한 이름을 준다. <em><strong>encryption</strong></em> 과 다른 설정은 디폴트로 둔다 - <em>사용자의 목적에 맞게 몇가지 파라미터를 설정할 수 있지만 테스트용이니 넘어간다</em> - API에서 queue에 접근하기 위해서는 각 queue의 url을 기억해두어야 한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/01c4c0721b2d25878f8724fd6b1d0f83/30c92/aws-sqs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.67088607594937%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACEElEQVR42oWS60uTYRiH3z8k7LQOaDbnuxOb1ZxO3+WwrV7bps2W60CRHcSI+lBEeIbISUHQd/NLDSIo6F/oQwg5Yeq25ly6D84YaO7dFXtWUUH0wMV9eLhv7uf53VKjxcUhw7H/Ut/o4GC9nfYOP4O3H3Bz8B4Dt+4L23/9Dv037gqk0fEoLkVlf51NFNY1HP2DWn3VHpabqdHJjE5Msba6Sjw+T3wuTjKZonJKpRKaVkLyqmHMdgW90YlsddFgdIriBlMLBnMLsrWt6pta2KmTeTj8iLKmUShsCIrFIpqm/WioIan+CN2hy/h7LuLxhgieuYTH20N37xU6T4ZQAxHU4HmsTW527DYwMj7Jt60tsstZ8mt5MW0ulxNxOpVCOtLcKSa02N00Wlppau7E0uTGZFNEbLK1izuzTWHXPiMj41EKhQKf5uZZSqZZWFwikVgQT0+nM0inAxfwqWFUfx/eU+Eq6ll8XefwdVXyEboCERytPvYcMDM8Nsn25ibLySRfMp/J51ZYyWRYXy+Iv5QUT5AKbcf9KJ4A7R0B3J6gwHMihNLhFzmHy0fNXgNDE0/Jv54i/riPhecDJJ71k3hyle3iV0rlMlJVACd62SmE+UlFiN992eISogyNRWEjy/biB7T0LFr6I1pqtiJzdcK/1+RfVPZQV2slHLnGyzfveRF7y0zs3S+mZ2JMz7ziOyRIrahLn2d/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aws-sqs\"\n        title=\"\"\n        src=\"/static/01c4c0721b2d25878f8724fd6b1d0f83/f058b/aws-sqs.png\"\n        srcset=\"/static/01c4c0721b2d25878f8724fd6b1d0f83/c26ae/aws-sqs.png 158w,\n/static/01c4c0721b2d25878f8724fd6b1d0f83/6bdcf/aws-sqs.png 315w,\n/static/01c4c0721b2d25878f8724fd6b1d0f83/f058b/aws-sqs.png 630w,\n/static/01c4c0721b2d25878f8724fd6b1d0f83/30c92/aws-sqs.png 874w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>연습</h2>\n<p>AWS SQS를 어플리케이션에 사용할 때 필요한 라이브러리들을 설치한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install --save express dotenv aws-sdk sqs-consumer</code></pre></div>\n<blockquote>\n<p>sqs-consumer - SQS메시지를 처리하는 async 함수를 정의하여 SQS 기반의 어플리케이션을 만들어 준다.</p>\n</blockquote>\n<p>이 글에 사용된 코드는 개인 github에서 찾아볼 수 있다 — <a href=\"https://github.com/shkim04/sqs-scenario\">https://github.com/shkim04/sqs-scenario</a></p>\n<p>아주 간단한 형태의 서버로 적용하는데 이는 AWS SQS를 적용하고 queue 메시지들이 어떻게 이동되는지에 더 초점을 맞추기 위함이다. 하나의 프로젝트 폴더 하위에 <strong>purchase, mileage</strong>와 <strong>productTracking</strong>라는 세 개의 폴더를 만든다. 그리고 각각 폴더 하위에 <code class=\"language-text\">server.js</code>라는 파일을 생성한다. <strong>purchase</strong> 하위에 있는 <code class=\"language-text\">server.js</code>에 아래 코드를 입력한다:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dotenv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./.env\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"express\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> aws <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aws-sdk\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> sqsClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">aws<span class=\"token punctuation\">.</span>SQS</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">region</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_REGION</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">accessKeyId</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_ACCESS_KEY_ID</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">secretAccessKey</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SECRET_ACCESS_KEY</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// always recommended to save credentials in .env file</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> <span class=\"token number\">3000</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_SQS_MILEAGE_URL</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SQS_MILEAGE_URL</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/purchase\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>id\n  <span class=\"token keyword\">const</span> username <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>username\n  <span class=\"token keyword\">const</span> price <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>price\n  <span class=\"token keyword\">const</span> mileageAccumulated <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>mileageAccumulated\n  <span class=\"token keyword\">const</span> trackingId <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>trackingId\n\n  <span class=\"token keyword\">const</span> mileagePayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">MessageBody</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> id<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">username</span><span class=\"token operator\">:</span> username<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">mileageAccumulated</span><span class=\"token operator\">:</span> mileageAccumulated<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">price</span><span class=\"token operator\">:</span> price<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">QueueUrl</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_SQS_MILEAGE_URL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> trackingPayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">MessageBody</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> id<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">username</span><span class=\"token operator\">:</span> username<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">trackingId</span><span class=\"token operator\">:</span> trackingId<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">QueueUrl</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> mileageResponse <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> sqsClient\n      <span class=\"token punctuation\">.</span><span class=\"token function\">sendMessage</span><span class=\"token punctuation\">(</span>mileagePayload<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> trackingReponse <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> sqsClient\n      <span class=\"token punctuation\">.</span><span class=\"token function\">sendMessage</span><span class=\"token punctuation\">(</span>trackingPayload<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>mileageResponse<span class=\"token punctuation\">,</span> trackingReponse<span class=\"token punctuation\">)</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Order Request Success\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"get /purchase error\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Order Request Fail From Server\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Server is running on </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>여기서 독자들이 환경 변수를 설정하고 불어오는 법에 대해 알고 위의 코드에 필요한 키와 url 값들을 입력했다고 가정하겠다.</p>\n<p>준비가 완료되면 <code class=\"language-text\">node ./purchase/server.js</code>를 입력하여 <strong>purchase</strong> 서버를 실행한다. <code class=\"language-text\">/purchase</code> 라우트에 Insomnia를 통해 요청을 보내서 기대한 대로 SQS에서 메시지가 queue에 보내지는지 확인해보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 491px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7f69834c2120c9f3bd5f4baf3cc916c0/13566/insomnia.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmElEQVR42n2Su27UQBSG/SZIaNld2zOeGc+Mr3hX3g3asIGGKlWqVOlpoUGiokHibXgDHoDH+dCx5YSghOLXmYvOd66Jzi3pNiPGSNu2VFU1nbuuo+/7yYYQWK/XbDabe223KS9XL7g+feL7x998vfvF59ufJFob8lxhrcV7j3PuXgIqy3L6y7KMPM8npWlKluWsNytOww131z+4/fCNm/dfSMrS0TQN1jq0Loixwjk/OUimEkRrPWUqFSzB6rrGGEOuUrbpim32ikxtSIqiQOSDx5YWX1qqKNkanLMs/+IsVuDL2yJrLFppurYjMabAFAbrDO2+ZH/wvDkFzleBYRdQSk+Q/0mg0hLpebJEN7ZgvPQcrwJN17DrR2KIZHmGUmpyfA7+CDg/CFBzOHvGU8X+0NPvA6EpqMNA9A1K5RSFnuD/ShgyqAkoE5SBxBgYxsB4GRmOnvEi8vZdzcWx53x+zeEoq1TOwc1jCUPAwzCQ/D01sUsAabRsgLUGVy5n+6TET7Lc7XZzyUKX/XooYdZ8f7rM50r+A4w6QErxJp1qAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"insomnia\"\n        title=\"\"\n        src=\"/static/7f69834c2120c9f3bd5f4baf3cc916c0/13566/insomnia.png\"\n        srcset=\"/static/7f69834c2120c9f3bd5f4baf3cc916c0/c26ae/insomnia.png 158w,\n/static/7f69834c2120c9f3bd5f4baf3cc916c0/6bdcf/insomnia.png 315w,\n/static/7f69834c2120c9f3bd5f4baf3cc916c0/13566/insomnia.png 491w\"\n        sizes=\"(max-width: 491px) 100vw, 491px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>위의 데이터가 <strong>purchase</strong> 서버에서 받아 SQS로 보낼 queue 메시지의 내용이다. **<em>send</em>**를 누르면 서버의 터미널에 다음과 같은 로그가 출력된다:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/72d5ee3930695ca6e2ed886160358cce/ef6b9/log-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.924050632911392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApklEQVR42lWOQW7DIBBFc5UExTBg2YSBkFRdWK0Te+P7H+dV0FUWo5k3X/p6p5wzqkophZIL4hwpKe0fpxkXHCEFfPR9yySE/M8yC/4WOrfMWcvpOA72fWfb3ry2FX0k7r+V5/uLulbSouia0Z9MeRXSkojfN2QUBhkYvMUG22/bCrMqtVZ88EgUxjIi0eNm6dxMmoVPzWTsJtfhijkbLufLxxhj+AOxtV03vAlSsAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"log-1\"\n        title=\"\"\n        src=\"/static/72d5ee3930695ca6e2ed886160358cce/f058b/log-1.png\"\n        srcset=\"/static/72d5ee3930695ca6e2ed886160358cce/c26ae/log-1.png 158w,\n/static/72d5ee3930695ca6e2ed886160358cce/6bdcf/log-1.png 315w,\n/static/72d5ee3930695ca6e2ed886160358cce/f058b/log-1.png 630w,\n/static/72d5ee3930695ca6e2ed886160358cce/ef6b9/log-1.png 832w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>메시지가 성공적으로 보내졌다.</p>\n<p><strong>mileage</strong>서버와 <strong>productTracking</strong> 서버가 이 메시지를 사용하기 위해 mileage 폴더 하위에 있는 <code class=\"language-text\">server.js</code>에 아래 코드를 입력한다:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dotenv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./.env\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> Consumer <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sqs-consumer\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_SQS_MILEAGE_URL</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SQS_MILEAGE_URL</span>\n\n<span class=\"token keyword\">const</span> mileageConsumerApp <span class=\"token operator\">=</span> Consumer<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">queueUrl</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_SQS_MILEAGE_URL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">handleMessage</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">message</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> messageBody <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> mileageInfo <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>messageBody<span class=\"token punctuation\">.</span>mileageAccumulated<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> price <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>messageBody<span class=\"token punctuation\">.</span>price<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> newMileage <span class=\"token operator\">=</span> mileageInfo <span class=\"token operator\">+</span> price <span class=\"token operator\">*</span> <span class=\"token number\">0.02</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"newMileage:\"</span><span class=\"token punctuation\">,</span> newMileage<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nmileageConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nmileageConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"processing_error\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nmileageConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>productTracking</strong> 폴더 하위에 있는 <code class=\"language-text\">server.js</code>에 아래 코드를 입력한다 — <em>앞서 언급했듯이 두 서버는 동일한 queue url을 사용하지 않는다</em>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dotenv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./.env\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> Consumer <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sqs-consumer\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span>\n\n<span class=\"token keyword\">const</span> productTrackingConsumerApp <span class=\"token operator\">=</span> Consumer<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">queueUrl</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_SQS_PRODUCT_TRACKING_URL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">handleMessage</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">message</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> messageBody <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> productTrackingId <span class=\"token operator\">=</span> messageBody<span class=\"token punctuation\">.</span>trackingId\n    <span class=\"token comment\">// tracking logic here</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"productTrackingId:\"</span><span class=\"token punctuation\">,</span> productTrackingId<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nproductTrackingConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nproductTrackingConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"processing_error\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nproductTrackingConsumerApp<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>터미널 두 개를 추가로 열어 두 서버를 실행한다. 두 서버는 queue로부터 메시지를 받고 메시지 안에 담긴 데이터를 처리할 것이다. 이를 확인하기 위해 <code class=\"language-text\">/purchase</code> 라우트로 다시 요청을 보내본 후 각 터미널에 출력된 로그를 확인한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 320px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b71dcd63a810d4214950a42b40de2e6e/72799/log-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.78481012658228%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABI0lEQVR42k2P2WrCYBSE8xSKNNEsvxWroNEYKBqzaIzGLEZKXVqvSvHavj98Jf9F6cUwc84chjmKbY9xZy7pLuX09s58/oppGoRBxLGsCP2Qsig5VhXH6kgQ+KTpnl2yJQwj8n2OM53gLQOiwEcZDAaMRiPCICRex9i2zXQyIdkkHMqKbVJzycf1wvVyZrWKyPNcBsZxTLbP8LwFm01CvF6htNsdNE2j1WpJ1FrXdcmqqmIYBupTh2ZDpdmoPROt3UE3DOnVt5ZlYZiG3Cl1u5kzw18u8TwPZ+owsW1c15XNhbBYeD3y4oXi0Gdsd3FmzzJESAip5SwEyu3zxvVypTqU5FkhXzifzvw8HmTpFiG6ZGWf7/uQr/uQIOxJmKb1F/Qfv+JxpFr+zuvFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"log-2\"\n        title=\"\"\n        src=\"/static/b71dcd63a810d4214950a42b40de2e6e/72799/log-2.png\"\n        srcset=\"/static/b71dcd63a810d4214950a42b40de2e6e/c26ae/log-2.png 158w,\n/static/b71dcd63a810d4214950a42b40de2e6e/6bdcf/log-2.png 315w,\n/static/b71dcd63a810d4214950a42b40de2e6e/72799/log-2.png 320w\"\n        sizes=\"(max-width: 320px) 100vw, 320px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 448px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e402758ca737104204aba488a79d4c3c/33b38/log-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.822784810126581%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmklEQVR42j2OSw7CMAxEe5Ym6aalRSoSEfk4TlOKgPtfZ5AtYDH2+M0s3I3jCH/1eBwHTtME7z0oE9rWkHJGDAFcGDll7TAX9aLLuiKEgGEY0Pc9jDHoZDjnYJ3TQGStVWaMVW+s/TPJtS/st7+Z7K4QoTJjqxtijCAiFGYUKng930gxYTkvICq4t10/CreAylXZ3preWXrzjA8EZmATHonNbAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"log-3\"\n        title=\"\"\n        src=\"/static/e402758ca737104204aba488a79d4c3c/33b38/log-3.png\"\n        srcset=\"/static/e402758ca737104204aba488a79d4c3c/c26ae/log-3.png 158w,\n/static/e402758ca737104204aba488a79d4c3c/6bdcf/log-3.png 315w,\n/static/e402758ca737104204aba488a79d4c3c/33b38/log-3.png 448w\"\n        sizes=\"(max-width: 448px) 100vw, 448px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Insomnia에 입력했던 데이터가 두 서버에서 기대했던 바와 같이 처리됐다.</p>\n<h2>결론</h2>\n<p>Queue 메시지는 방대한 양의 데이터와 요청이 있을 때 발생할 예상치 못한 상황을 통제하는데 도움이 될 수 있다. SQS가 괜찮은 솔루션이지만 적용할 수 있는 유일한 queue 메시지 플랫폼은 아니다. 이 글에서 얻은 기초를 통해 각자의 어플리케이션에 적용할 수 있는 최적의 queue 플랫폼을 찾아보기를 권하며 글을 마친다.</p>\n<p><em><strong>읽어 주셔서 감사합니다. To be continued!</strong></em></p>\n<p><em>이 글은 <a href=\"https://medium.com/@shkim04/how-to-use-aws-sqs-on-node-js-e932fea9f2ef\">Medium</a>에도 업로드 되었습니다.</em>\n<em>놀러 오세요!</em></p>","frontmatter":{"title":"Node.js 어플리케이션에서 AWS SQS 사용하기","date":"2023년 02월 05일","description":"","tag":["Cloud","NodeJS"]},"fields":{"locale":"ko"}},"previous":{"fields":{"slug":"/python-pandas-엑셀-사용하기"},"frontmatter":{"title":"Python에서 pandas로 엑셀 다루기"}},"next":{"fields":{"slug":"/nodejs-google-error-reporting-사용하기"},"frontmatter":{"title":"Node.js에서 Google Error Reporting 사용하기"}}},"pageContext":{"locale":"ko","isDefaultLang":true,"slug":"/nodejs-aws-sqs-사용하기","titleByLang":{"ko":"nodejs-aws-sqs-사용하기","en":"how-to-use-aws-sqs-nodejs"},"dateFormat":"YYYY년 MM월 DD일","id":"cf7f4615-3f05-590c-a145-1e742cd08f9f","previousPostId":"7e2506ed-11d6-5e9d-bc36-084022597c68","nextPostId":"e5c6ce21-ae9f-54cd-9157-1e1b2fa01e06"}},"staticQueryHashes":[],"slicesMap":{}}